<ion-header class="chat-header" [translucent]="true">
  <ion-toolbar>
    <ng-container *ngIf="selectedMessages.length > 0; else defaultHeader">
      <ion-title>{{ selectedMessages.length }} selected</ion-title>
      <ion-buttons slot="end">
        <!-- ‚úÖ Only 1 Text Message -->
        <ng-container *ngIf="isOnlyOneTextMessage()">
          <ion-button (click)="replyToMessages()">
            <ion-icon name="return-up-back-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="copySelectedMessages()">
            <ion-icon name="copy-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="onMore($event)">
            <ion-icon name="ellipsis-vertical-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- ‚úÖ Multiple Text Messages -->
        <ng-container *ngIf="isMultipleTextMessages()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="copySelectedMessages()">
            <ion-icon name="copy-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- ‚úÖ Only 1 Attachment -->
        <ng-container *ngIf="isOnlyOneAttachment()">
          <ion-button (click)="replyToMessages()">
            <ion-icon name="return-up-back-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="onMore($event)">
            <ion-icon name="ellipsis-vertical-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- ‚úÖ Multiple Attachments -->
        <ng-container *ngIf="isMultipleAttachments()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- ‚úÖ Mixed: text + attachment -->
        <ng-container *ngIf="isMixedSelection()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ng-container>
      </ion-buttons>
    </ng-container>

    <!-- üîÅ Default Chat Header -->
    <ng-template #defaultHeader>
      <ion-buttons
        *ngIf="!showSearchBar"
        slot="start"
        style="color: black; width: 8%"
      >
        <ion-icon
          name="arrow-back-outline"
          class="back-icon"
          (click)="onBack()"
          style="font-size: 24px; cursor: pointer"
        >
        </ion-icon>
      </ion-buttons>

      <ng-container *ngIf="!showSearchBar; else searchBar">
        <ion-buttons>
          <ion-item
            lines="none"
            style="--padding-start: 0; --background: white; color: black"
            detail="false"
          >
            <!-- ‚úÖ Avatar with fallback to initial letter -->
            <ng-container
              *ngIf="currentConv?.avatar && currentConv?.avatar !== 'assets/images/default-avatar.png'; else headerInitialsTpl"
            >
              <ion-avatar style="margin-left: 10px" slot="start">
                <img
                  [src]="currentConv?.avatar"
                  alt="User Avatar"
                  (error)="setDefaultAvatar($event)"
                />
              </ion-avatar>
            </ng-container>

            <ng-template #headerInitialsTpl>
              <ion-avatar style="margin-left: 10px" slot="start">
                <div class="header-avatar-initial">
                  {{ currentConv?.title?.charAt(0)?.toUpperCase() || '?' }}
                </div>
              </ion-avatar>
            </ng-template>

            <ion-label
              (click)="goToProfile()"
              style="
                width: auto;
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                cursor: pointer;
              "
            >
              <h2>{{ currentConv?.title||"Chat title" }}</h2>

              <!-- ‚úÖ UPDATED: Presence & Typing Status -->
              <div
                style="
                  font-size: 12px;
                  margin-top: 4px;
                  display: flex;
                  align-items: center;
                  gap: 4px;
                "
              >
                <!-- ‚úÖ Private Chat -->
                <ng-container *ngIf="currentConv?.type === 'private'">
                  <!-- Check if typing users exist using the new method -->
                  <ng-container
                    *ngIf="currentConv && currentConv.roomId && (getTypingStatusForConv(currentConv.roomId) | async) as users"
                  >
                    <ng-container *ngIf="users.length > 0">
                      <!-- Show typing indicator -->
                      <span style="color: var(--ion-color-primary)"
                        >typing‚Ä¶</span
                      >
                    </ng-container>

                    <!-- Show online/last seen when NOT typing -->
                    <ng-container *ngIf="users.length === 0">
                      <ng-container
                        *ngIf="receiverStatus === 'online'; else lastSeenTpl"
                      >
                        <span class="online-dot" aria-hidden="true"></span>
                        <span style="color: var(--ion-color-primary)"
                          >Online</span
                        >
                      </ng-container>

                      <ng-template #lastSeenTpl>
                        <span class="last-seen-text" *ngIf="lastSeenTime">
                          {{ lastSeenTime }}
                        </span>
                      </ng-template>
                    </ng-container>
                  </ng-container>

                  <!-- Fallback when roomId is not available -->
                  <ng-container *ngIf="!currentConv || !currentConv.roomId">
                    <ng-container
                      *ngIf="receiverStatus === 'online'; else lastSeenTpl2"
                    >
                      <span class="online-dot" aria-hidden="true"></span>
                      <span style="color: var(--ion-color-primary)"
                        >Online</span
                      >
                    </ng-container>

                    <ng-template #lastSeenTpl2>
                      <span class="last-seen-text" *ngIf="lastSeenTime">
                        {{ lastSeenTime }}
                      </span>
                    </ng-template>
                  </ng-container>
                </ng-container>

                <!-- ‚úÖ Group/Community Chat -->
                <ng-container
                  *ngIf="currentConv?.type === 'group' || currentConv?.type === 'community'"
                >
                  <!-- Check if typing users exist using the new method -->
                  <ng-container
                    *ngIf="currentConv && currentConv.roomId && (getTypingStatusForConv(currentConv.roomId) | async) as users"
                  >
                    <ng-container *ngIf="users.length > 0">
                      <!-- Show typing count -->
                      <span style="color: var(--ion-color-primary)">
                        {{ users.length }} {{ users.length === 1 ? 'person is' :
                        'people are' }} typing‚Ä¶
                      </span>
                    </ng-container>

                    <!-- Show member count when NOT typing -->
                    <ng-container *ngIf="users.length === 0">
                      <span style="color: var(--ion-color-medium)">
                        {{ currentConv.members?.length || 0 }} members
                      </span>
                    </ng-container>
                  </ng-container>

                  <!-- Fallback when roomId is not available -->
                  <ng-container *ngIf="!currentConv || !currentConv.roomId">
                    <span style="color: var(--ion-color-medium)">
                      {{ currentConv?.members?.length || 0 }} members
                    </span>
                  </ng-container>
                </ng-container>
              </div>
            </ion-label>
          </ion-item>
        </ion-buttons>
      </ng-container>

      <ng-template #searchBar>
        <ion-item
          lines="none"
          style="
            margin-top: 10px;
            padding: 10px 15px;
            --border-radius: 25px;
            --background: #f5f5f5;
            width: 100%;
          "
        >
          <ion-icon
            name="arrow-back-outline"
            slot="start"
            style="font-size: 24px; cursor: pointer; margin-right: 10px"
            (click)="cancelSearch()"
          ></ion-icon>
          <ion-input
            placeholder="Search messages..."
            [(ngModel)]="searchText"
            (ionInput)="onSearchInput()"
            style="margin-left: 10px; flex: 1"
          >
          </ion-input>
          <ion-buttons slot="end">
            <!-- <ion-button (click)="openDatePicker()">
            <ion-icon name="calendar-outline"></ion-icon>
          </ion-button> -->
            <ion-button (click)="openPopover($event)">
              <ion-icon name="calendar-outline"></ion-icon>
            </ion-button>
            <ion-button (click)="navigateSearch('up')">
              <ion-icon name="arrow-up-outline"></ion-icon>
            </ion-button>
            <ion-button (click)="navigateSearch('down')">
              <ion-icon name="arrow-down-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-item>
      </ng-template>

      <ion-buttons *ngIf="!showSearchBar" slot="end" style="margin-top: 15px">
        <!-- <ion-button style="color: black">
          <ion-icon name="videocam-outline" style="font-size: 35px"></ion-icon>
        </ion-button> -->
        <ion-button style="color: black" class="chat_ion_button">
          <ion-icon
            name="videocam-outline"
            style="font-size: 35px"
            class="chatting_head_icons"
          ></ion-icon>
        </ion-button>
        <!-- <ion-button (click)="goToCallingScreen()" style="color: black">
          <ion-icon name="call-outline" style="font-size: 28px"></ion-icon>
        </ion-button> -->
        <ion-button
          (click)="goToCallingScreen()"
          style="color: black"
          class="chat_ion_button"
        >
          <ion-icon
            name="call-outline"
            style="font-size: 28px"
            class="chatting_head_icons"
          ></ion-icon>
        </ion-button>
        <!-- <ion-button (click)="openOptions($event)" style="color: black"> -->
        <ion-button
          (click)="openOptions($event)"
          style="color: black"
          class="chat_ion_button"
        >
          <ion-icon
            name="ellipsis-vertical-outline"
            style="font-size: 28px"
            class="chatting_head_icons"
          ></ion-icon>
        </ion-button>
      </ion-buttons>
    </ng-template>
  </ion-toolbar>
</ion-header>

<ion-content class="chat-background" [fullscreen]="true" [scrollEvents]="true">
  <!-- Pinned Message Banner (Alternative/Mobile View) -->
  <!-- <div class="fordark"><img src="/assets/images/chat_bg.jpg" alt="" /></div> -->
  <div class="chat-background"></div>

  <div
    #scrollContainer
    class="chat-messages"
    style="padding: 10px 10px 10px 10px; overflow-y: auto; min-height: 100%"
  >
    <!-- System block/unblock bubbles (only visible to blocker) -->
    <div
      *ngIf="showBlockBubble"
      class="system-bubble-wrapper"
      style="display: flex; justify-content: center; margin: 10px 0"
    >
      <div class="system-bubble" (click)="unblockFromChat()">
        You blocked this contact. Tap to unblock.
      </div>
    </div>

    <div
      *ngIf="showUnblockBubble"
      class="system-bubble-wrapper"
      style="display: flex; justify-content: center; margin: 10px 0"
    >
      <div class="system-bubble system-bubble-success">
        You unblocked this contact.
      </div>
    </div>

    <ion-spinner
      name="dots"
      *ngIf="isLoadingMore"
      style="margin: 8px auto; display: block"
    ></ion-spinner>

    <div *ngFor="let group of groupedMessages">
      <div
        class="date-divider"
        [id]="'date-group-' + group.date"
        *ngIf="group.messages && group.messages.length > 0"
      >
        <div class="text-bg-white date-label">{{ group.date }}</div>
      </div>

<ng-container *ngFor="let msg of group.messages">
  <div
    class="msg-row"
    [ngClass]="{
      'align-end': msg.sender === senderId,
      'align-start': msg.sender !== senderId,
      'selected': isSelected(msg),
       'pinned-message-highlight': pinnedMessage && pinnedMessage.messageId === msg.message_id
    }"
    *ngIf="!isMessageHiddenForUser(msg)"
    style="display: flex; flex-direction: column; margin: 5px 0"
    (touchstart)="startLongPress(msg)"
    (touchend)="cancelLongPress()"
    (touchmove)="cancelLongPress()"
    (click)="onMessageClick(msg)"
  >

    <!-- ================= AUDIO ONLY (NO MESSAGE BUBBLE) ================= -->
    <ng-container *ngIf="msg.attachment?.type === 'audio'; else normalMessage">

      <div
        class="wa-audio-wrapper"
        [class.my-audio]="msg.isMe"
        [class.other-audio]="!msg.isMe"
        (click)="$event.stopPropagation()"
      >
        <!-- ‚ñ∂ Play / Pause -->
        <button
          class="wa-play-btn"
          (click)="toggleMsgAudio(msg, audioEl)"
        >
          <ion-icon
            [name]="msg._isPlaying ? 'pause' : 'play'"
          ></ion-icon>
        </button>

        <!-- Fake Waveform -->
        <div class="wa-waveform">
          <span
            class="dot"
            *ngFor="let i of [].constructor(28)"
            [class.active]="msg._isPlaying"
          ></span>
        </div>

        <!-- Current Time -->
        <span class="wa-time">
          {{ msg._currentTime  }}
        </span>

        <!-- Speed / Avatar -->
        <ng-container *ngIf="!msg._isPlaying; else speedTpl">
          <div class="wa-dp">
            <img
              [src]="currentConv?.avatar || 'assets/images/default-avatar.png'"
              (error)="setDefaultAvatar($event)"
            />
            <ion-icon name="mic" class="mic-icon"></ion-icon>
          </div>
        </ng-container>

        <ng-template #speedTpl>
          <button
            class="wa-speed"
            (click)="toggleMsgSpeed(msg, audioEl)"
          >
            {{ msg._speed || '1x' }}
          </button>
        </ng-template>

        <!-- ‚úÖ TIME + TICKS INSIDE AUDIO -->
        <div class="wa-audio-meta">
          <span class="time">{{ msg.time }}</span>

          <ng-container
            *ngIf="getStatusIconDescriptorByMsgId(msg.msgId) as icon"
          >
            <ion-icon
              [name]="icon.name"
              [ngClass]="icon.cls"
            ></ion-icon>
          </ng-container>
        </div>

        <!-- Hidden Audio -->
      <audio
  #audioEl
  [src]="msg.attachment?.localUrl?.startsWith('https://')
    ? msg.attachment?.localUrl
    : escapeUrl(msg.attachment?.cdnUrl)"
  (loadedmetadata)="onMsgAudioLoaded(msg, audioEl)"
  (timeupdate)="updateMsgAudioTime(msg, audioEl)"
  (pause)="onMsgAudioPaused(msg)"
  (ended)="resetMsgAudio(msg)"
></audio>

      </div>

    </ng-container>

    <!-- ================= NORMAL MESSAGE (UNCHANGED) ================= -->
    <ng-template #normalMessage>

      <div
        class="message-bubble"
        (click)="openAttachmentModal(msg)"
        [attr.data-msg-key]="msg.msgId"
        [class.my-message]="msg.isMe"
        [ngClass]="[
          msg.isMe ? 'sender-message' : 'receiver-message',
          msg.fadeOut ? 'fade-out' : ''
        ]"
      >

        <!-- üîÅ EVERYTHING BELOW IS YOUR ORIGINAL CODE (UNCHANGED) -->

        <!-- Forwarded Label -->
        <div *ngIf="msg.isForwarded" class="forwarded-label">
              <ion-icon
                name="arrow-undo-outline"
                class="forwarded-icon"
              ></ion-icon>
          Forwarded
        </div>

        <!-- Group Sender Name -->
        <span
          *ngIf="chatType === 'group' && msg.sender !== senderId"
          style="font-size: 10px; color: #bc8c2c"
        >
          {{ getSenderDisplayName(msg) }}
        </span>

        <!-- Replied Message -->
        <div
          class="replied-message"
          *ngIf="msg.replyToMsgId"
          (click)="scrollToRepliedMessage(msg.replyToMsgId)"
        >
          <ng-container
            *ngIf="getRepliedMessage(msg.replyToMsgId) as repliedMsg"
          >
                <div
                  class="replied-container"
                  (click)="scrollToRepliedMessage(msg.replyToMsgId)"
                >
              <div class="replied-header">
                    <ion-icon
                      name="arrow-undo-outline"
                      class="reply-icon"
                    ></ion-icon>
                    <span class="replied-sender">
                  {{ repliedMsg.isMe ? 'You' : currentConv?.title }}
                </span>
              </div>
                  <div class="replied-content">
                    <div class="replied-text" *ngIf="repliedMsg.text">
                {{ getReplyPreviewText(repliedMsg) }}
                    </div>
                    <div
                      class="replied-attachment"
                      *ngIf="repliedMsg.attachment"
                    >
                      <ion-icon name="attach-outline"></ion-icon>
                      {{ getReplyPreviewText(repliedMsg) }}
                    </div>
              </div>
            </div>
          </ng-container>
        </div>

            <!-- Normal Message -->
            <ng-container *ngIf="!msg.isDeleted">
              <!-- If no attachment and has text -->
              <!-- <ng-container *ngIf="!msg.attachment && msg.text"> -->
              <ng-container
                *ngIf="msg.text && (!msg.attachment || isEmptyObject(msg.attachment))"
              >
                <!-- SIMPLE TRANSLATION BAR (only toggle button, if translations exist) -->
                <div
                  class="translation-bar"
                  *ngIf="msg.translations && hasMultipleTranslations(msg)"
                  (click)="$event.stopPropagation()"
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 4px 8px;
                    background: rgba(0, 0, 0, 0.05);
                    border-radius: 6px 6px 0 0;
                    font-size: 11px;
                  "
                >
                  <div style="color: #666">
                    <small
                      *ngIf="getActiveTranslationLabel(msg) as activeLabel"
                    >
                      {{ activeLabel }}
                    </small>
                  </div>

                  <!-- Simple Toggle Button -->
                  <button
                    (click)="cycleTranslation(msg); $event.stopPropagation()"
                    title="Translate"
                    aria-label="Translate"
                    style="
                      background: transparent;
                      border: none;
                      font-size: 18px;
                      cursor: pointer;
                      padding: 2px 6px;
                      color: #3880ff;
                      display: flex;
                      align-items: center;
                    "
                  >
                    <ion-icon name="language-outline"></ion-icon>
                  </button>
                </div>

                <!-- VISIBLE TEXT (active translation) -->
                <ion-text
                  class="message-text"
                  (click)="$event.stopPropagation()"
                >
                  {{ msg.translations ? getDisplayedText(msg) : msg.text }}
                </ion-text>
              </ng-container>

              <!-- <ng-container *ngIf="msg.attachment"> -->
              <ng-container
                *ngIf="msg.attachment && !isEmptyObject(msg.attachment)"
              >
                <!-- existing attachment markup ‚Äî keep as before -->
                <!--getPreviewUrl(msg) -->
                <img
                  *ngIf="msg.attachment.type === 'image'"
                  [src]="msg.attachment.localUrl?.startsWith('https://') 
          ? msg.attachment.localUrl
          : escapeUrl(msg.attachment.cdnUrl)"
                  alt="Image"
                  style="max-width: 200px; border-radius: 10px; margin: 5px 0"
                />
                <video
                  *ngIf="msg.attachment.type === 'video'"
                  controls
                  style="max-width: 200px; border-radius: 10px; margin: 5px 0"
                >
                  <source
                    [src]="msg.attachment.localUrl?.startsWith('https://') 
          ? msg.attachment.localUrl 
          : escapeUrl(msg.attachment.cdnUrl)"
                    [type]="msg.attachment.mimeType || 'video/mp4'"
                  />
                </video>
                <audio
                  *ngIf="msg.attachment.type === 'audio'"
                  controls
                  style="margin: 5px 0"
                >
                  <source
                    [src]="msg.attachment.localUrl?.startsWith('https://')
          ? msg.attachment.localUrl 
          : escapeUrl(msg.attachment.cdnUrl)"
                    [type]="msg.attachment.mimeType || 'audio/mpeg'"
                  />
                </audio>
                <div
                  *ngIf="msg.attachment.type === 'file'"
                  style="margin: 5px 0"
                >
                  <ion-icon
                    name="document-outline"
                    style="margin-right: 5px"
                  ></ion-icon>
                  <a
                    [href]="msg.attachment.previewUrl"
                    [download]="msg.attachment.fileName || 'file'"
                    target="_blank"
                    rel="noopener"
                  >
                    {{ msg.attachment.fileName || 'Download File' }}
                  </a>
                </div>

                <ion-text
                  class="message-text"
                  *ngIf="msg.text"
                  style="margin-top: 5px"
                >
          {{ msg.text }}
        </ion-text>
              </ng-container>
            </ng-container>

        <!-- Timestamp -->
        <p class="time-stamp status-container">
              <ion-icon
                *ngIf="msg.isPinned"
                name="pin"
                class="pin-indicator-timestamp"
              ></ion-icon>
          {{ msg.time }}
              <span
                *ngIf="msg.isEdit"
                style="font-size: 11px; color: gray; margin-left: 4px"
                >(edited)</span
              >
          <ng-container
            *ngIf="getStatusIconDescriptorByMsgId(msg.msgId) as icon"
          >
            <ion-icon
              [name]="icon.name"
              [ngClass]="icon.cls"
                  [attr.title]="icon.title"
            ></ion-icon>
          </ng-container>
        </p>

            <!-- üü° COMPACT REACTION BADGE (WhatsApp style) -->
            <div
              class="reaction-badges"
              *ngIf="msg.reactions && msg.reactions.length > 0 && getReactionsCount(msg) > 0"
              [class.right]="msg.sender === senderId"
              [class.left]="msg.sender !== senderId"
            >
              <ng-container *ngFor="let b of msg.reactions">
                <div
                  *ngIf="b.emoji"
                  class="badge"
                  [class.mine]="b.userId == senderId"
                  (click)="onReactionBadgeClick($event, msg, b)"
                >
                  <span class="emoji">{{ b.emoji }}</span>
                </div>
              </ng-container>
              <span class="cnt" *ngIf="getReactionsCount(msg) > 1">
                {{ getReactionsCount(msg) }}
              </span>
            </div>
      </div>

    </ng-template>

    <!-- Floating Reaction Bar (UNCHANGED) -->
    <div
      class="reaction-bar"
      *ngIf="isQuickReactionOpen(msg)"
      [class.right]="msg.sender === senderId"
      [class.left]="msg.sender !== senderId"
            (click)="$event.stopPropagation()"
            style="z-index: 1000; position: relative"
          >
            <button
              class="react-btn"
              (click)="addReaction(msg, 'üëç'); $event.stopPropagation()"
            >
              üëç
            </button>
            <button
              class="react-btn"
              (click)="addReaction(msg, '‚ù§Ô∏è'); $event.stopPropagation()"
            >
              ‚ù§Ô∏è
            </button>
            <button
              class="react-btn"
              (click)="addReaction(msg, 'üòÇ'); $event.stopPropagation()"
            >
              üòÇ
            </button>
            <button
              class="react-btn"
              (click)="addReaction(msg, 'üòÆ'); $event.stopPropagation()"
            >
              üòÆ
            </button>
            <button
              class="react-btn"
              (click)="addReaction(msg, 'üò¢'); $event.stopPropagation()"
            >
              üò¢
            </button>
            <button
              class="react-btn"
              (click)="addReaction(msg, 'üôè'); $event.stopPropagation()"
            >
              üôè
            </button>
            <button
              class="react-btn more"
              (click)="openEmojiKeyboard(msg); $event.stopPropagation()"
            >
              Ôºã
            </button>   
    </div>
  </div>
</ng-container>
    </div>
  </div>
</ion-content>

<ion-modal [isOpen]="showPreviewModal" (didDismiss)="showPreviewModal = false">
  <ng-template>
    <ion-header [translucent]="true" class="model-header">
      <ion-toolbar class="model-toll">
        <ion-buttons slot="start">
          <ion-icon
            (click)="cancelAttachment()"
            name="close"
            style="font-size: 25px"
          ></ion-icon>
        </ion-buttons>
        <ion-buttons slot="end" class="pre-icons">
          <!-- Show pencil icon only for images -->

          <img
            *ngIf="selectedAttachment?.type === 'image'"
            src="assets/images/crop-simple-solid-full.svg"
            alt="pencil"
            (click)="openCropperModal()"
            style="cursor: pointer"
          />
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="">
      <div class="pre-model">
        <div class="mine2">
          <div
            *ngIf="selectedAttachment?.type === 'image'"
            class="cropped-image"
          >
            <img [src]="selectedAttachment?.previewUrl" class="preview-image" />
          </div>
          <div *ngIf="selectedAttachment?.type === 'video'">
            <video
              controls
              [src]="selectedAttachment?.previewUrl"
              class="preview-video"
            ></video>
          </div>
          <div *ngIf="selectedAttachment?.type === 'file'" class="preview-file">
            <ion-icon
              name="document-attach-outline"
              style="font-size: 48px"
            ></ion-icon>
            <p>{{ selectedAttachment?.fileName }}</p>
          </div>
        </div>
        <div class="mine ion-padding">
          <ion-textarea
            [(ngModel)]="messageText"
            placeholder="Type your message here..."
            class="pre-message"
          ></ion-textarea>
          <div class="sendbtn">
            <!-- <p>{{ receiver_name }}</p> -->
            <ion-icon
              name="send-outline"
              (click)="sendMessage()"
              class="mediasend"
              [class.sending]="isSending"
              [style.pointer-events]="isSending ? 'none' : 'auto'"
              [style.opacity]="isSending ? '0.5' : '1'"
            >
            </ion-icon>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- ‚úÖ Message Input Footer -->
<!-- ========================= -->
<!-- Message Input Footer (updated) -->
<div class="footer-fixed" [class.typing-state]="showCompressedActions">
  <!-- Normal footer: typing indicator, reply preview, input row -->

  <div
    *ngIf="!isCurrentUserMember()"
    style="
      padding: 16px;
      text-align: center;
      background: #f5f5f5;
      border-top: 1px solid #ddd;
    "
  >
    <ion-text color="medium">
      <p style="margin: 0">You are not a member of this group</p>
    </ion-text>
  </div>

  <div *ngIf="isCurrentUserMember() && !iBlocked">
    <!-- ‚úÖ UPDATED: Typing indicator (above keyboard) -->
    <div
      class="typing-indicator-wrapper"
      *ngIf="isReceiverTyping || typingCount > 0"
    >
      <!-- PRIVATE CHAT layout -->
      <div
        *ngIf="currentConv?.type === 'private' && isReceiverTyping"
        class="typing-indicator-content private"
      >
        <div
          class="typing-dots center-only"
          aria-hidden="true"
          role="status"
          aria-label="typing"
        >
          <span class="dot"></span><span class="dot"></span
          ><span class="dot"></span>
        </div>
      </div>

      <!-- GROUP CHAT layout -->
      <div
        *ngIf="currentConv?.type === 'group' && typingCount > 0"
        class="typing-indicator-content group"
      >
        <div class="typing-text">
          <div class="typing-avatars">
            <!-- Single user typing -->
            <ng-container *ngIf="typingCount === 1 && typingUsers.length >= 1">
              <img
                class="typing-avatar single"
                [src]="typingUsers[0].avatar || 'assets/images/default-avatar.png'"
                (error)="setDefaultAvatar($event)"
                [alt]="typingUsers[0].name || 'User'"
              />
            </ng-container>

            <!-- Multiple users typing -->
            <ng-container *ngIf="typingCount >= 2">
              <div class="avatar-stack">
                <img
                  *ngFor="let u of typingUsers.slice(0,3); let i = index"
                  class="typing-avatar stacked idx-{{i}}"
                  [src]="u.avatar || 'assets/images/default-avatar.png'"
                  (error)="setDefaultAvatar($event)"
                  [alt]="u.name || 'User'"
                />
                <div class="more-badge" *ngIf="typingCount > 3">
                  +{{ typingCount - 3 }}
                </div>
              </div>
            </ng-container>
          </div>
        </div>

        <div
          class="typing-dots"
          aria-hidden="true"
          role="status"
          aria-label="typing"
        >
          <span class="dot"></span><span class="dot"></span
          ><span class="dot"></span>
        </div>
      </div>
    </div>
    <!-- ========================= -->

    <!-- REPLY PREVIEW -->
    <div class="reply-preview" *ngIf="replyToMessage">
      <div class="reply-header">
        <span class="reply-to-text"
          >Replying to {{ replyTo?.sender?.username || "You"}}</span
        >
        <ion-button fill="clear" size="small" (click)="cancelReply()">
          <ion-icon name="close" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
      <div class="reply-content">
        <div class="reply-line"></div>
        <div class="reply-message">
          {{ getReplyPreviewText(replyToMessage) }}
        </div>
      </div>
    </div>

    <!-- INPUT ROW -->
    <ion-row class="footer-row" style="align-items: center">
      <ion-col
        class="message-input-container"
        style="
          display: flex;
          flex-direction: column;
          align-items: stretch;
          gap: 8px;
        "
      >
        <div style="display: flex; align-items: center; gap: 8px">
          <ion-icon
            name="happy-outline"
            class="icon-left"
            (click)="openEmojiKeyboardForInput()"
          ></ion-icon>

          <!-- <ion-textarea [disabled]="iBlocked" [autoGrow]="true" [(ngModel)]="messageText" placeholder="Message"
            (ionInput)="onMessageInput($event)" (ionFocus)="onInputFocus()" (ionBlur)="onInputBlur()"
            (keyup.enter)="sendMessage()" class="message-input" labelPlacement="fixed"></ion-textarea> -->
          <ion-textarea
            class="message-input"
            [(ngModel)]="messageText"
            placeholder="Message"
            [autoGrow]="true"
            rows="1"
            labelPlacement="fixed"
            (ionInput)="onMessageInput($event)"
            (ionFocus)="onInputFocus()"
            (ionBlur)="onInputBlur()"
            (keyup.enter)="sendMessage()"
            [disabled]="iBlocked"
            style="
              --padding-top: 10px;
              --padding-bottom: 10px;
              --padding-start: 0px;
              --padding-end: 0px;
              --line-height: 20px;
              min-height: 44px;
            "
          >
          </ion-textarea>

          <ion-icon
            *ngIf="currentConv?.type === 'private'"
            name="language-outline"
            class="icon-left action-icon"
            (click)="toggleTranslationOptions()"
            style="font-size: 22px"
          >
          </ion-icon>

          <ion-icon
            name="attach-outline"
            (click)="pickAttachment()"
            class="icon-right action-icon"
            [hidden]="iBlocked"
          ></ion-icon>
          <ion-icon
            name="camera-outline"
            class="icon-right action-icon"
            (click)="openCamera()"
            [hidden]="iBlocked"
          ></ion-icon>
          <!-- COMPRESSED ICON (TYPING STATE) -->
          <ion-icon
            name="ellipsis-horizontal-outline"
            class="compressed-menu-icon"
            (click)="openMoreActions()"
          >
          </ion-icon>
        </div>

        <!-- üåê Translation Options -->
        <div
          *ngIf="showTranslationOptions && currentConv?.type === 'private'"
          class="translation-options"
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f5f5f5;
            border-radius: 12px;
            padding: 6px 10px;
            margin-top: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            gap: 8px;
          "
        >
          <!-- ‚úÖ Custom Language Dropdown -->
          <ion-select
            interface="popover"
            placeholder="Translate to..."
            (ionChange)="onSelectTranslateLanguage($event)"
            [disabled]="isTranslatingCustom || isTranslatingToReceiver"
            style="flex: 1; max-width: 60%"
          >
            <ion-select-option
              *ngFor="let lang of languagesList"
              [value]="lang"
            >
              {{ lang.label }}
            </ion-select-option>
          </ion-select>

          <!-- ‚úÖ Translate to Receiver Button -->
          <ion-button
            size="small"
            fill="outline"
            color="medium"
            (click)="translateTo('receiver')"
            [disabled]="isTranslatingCustom || isTranslatingToReceiver"
            style="flex: 1; --padding-start: 8px; --padding-end: 8px"
          >
            <ion-spinner
              *ngIf="isTranslatingToReceiver"
              name="crescent"
              slot="start"
              style="width: 14px; height: 14px"
            ></ion-spinner>
            <span *ngIf="!isTranslatingToReceiver" style="font-size: 11px">
              Demmlang ({{receiverLangLabel}})
            </span>
            <span *ngIf="isTranslatingToReceiver" style="font-size: 11px">
              Translating...
            </span>
          </ion-button>
        </div>

        <!-- üåê TRANSLATION CARD - Shows up to 3 translations -->
        <div
          *ngIf="translationCard?.visible"
          class="translation-card"
          role="region"
          aria-label="Translation preview"
          style="
            background: white;
            border-radius: 12px;
            padding: 12px;
            margin-top: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 3px solid #3880ff;
          "
        >
          <!-- CARD HEADER -->
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <div style="display: flex; align-items: center; gap: 6px">
              <ion-icon
                name="language-outline"
                style="font-size: 18px; color: #3880ff"
              ></ion-icon>
              <strong style="font-size: 13px; color: #333">
                <ng-container *ngIf="translationCard?.items?.length as count">
                  <strong style="font-size: 13px; color: #333">
                    {{ count }} Translation{{ count > 1 ? 's' : '' }} Ready
                  </strong>
                </ng-container>

                <ng-container *ngIf="!(translationCard?.items?.length)">
                  <strong style="font-size: 13px; color: #333">
                    0 Translations Ready
                  </strong>
                </ng-container>
              </strong>
            </div>
            <small style="color: #666; font-size: 11px">
              {{ translationCard?.createdAt | date: 'shortTime' }}
            </small>
          </div>

          <!-- CARD BODY - All Translations -->
          <div
            style="
              display: flex;
              flex-direction: column;
              gap: 8px;
              margin-bottom: 10px;
            "
          >
            <div
              *ngFor="let t of (translationCard?.items || []); let i = index"
              style="
                background: #f8f9fa;
                border-radius: 8px;
                padding: 8px 10px;
                display: flex;
                flex-direction: column;
                gap: 4px;
              "
              [style.border-left]="i === 0 ? '3px solid #28a745' : (t.label.includes('Receiver') ? '3px solid #ff6b6b' : '3px solid #3880ff')"
            >
              <!-- Language Label & Code -->
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <span
                  style="font-size: 11px; font-weight: 600"
                  [style.color]="i === 0 ? '#28a745' : (t.label.includes('Receiver') ? '#ff6b6b' : '#3880ff')"
                >
                  {{ t.label }}
                </span>
                <span
                  style="
                    font-size: 10px;
                    background: #e0e0e0;
                    padding: 2px 6px;
                    border-radius: 4px;
                    color: #666;
                  "
                >
                  {{ t.code }}
                </span>
              </div>

              <!-- Translated Text -->
              <div style="font-size: 13px; color: #333; line-height: 1.4">
                {{ t.text }}
              </div>
            </div>

            <!-- EMPTY STATE -->
            <div
              *ngIf="!(translationCard?.items?.length)"
              style="
                text-align: center;
                padding: 12px;
                color: #999;
                font-size: 12px;
              "
            >
              No translations available
            </div>
          </div>

          <!-- CARD ACTIONS -->
          <div style="display: flex; justify-content: flex-end; gap: 8px">
            <ion-button
              size="small"
              fill="clear"
              color="medium"
              (click)="closeTranslationCard()"
              [disabled]="isSendingFromTranslationCard"
              style="--padding-start: 10px; --padding-end: 10px"
            >
              Cancel
            </ion-button>

            <!-- ‚úÖ UPDATED: Send Button with Loader Animation -->
            <ion-button
              size="small"
              color="primary"
              (click)="sendFromTranslationCard()"
              [disabled]="isSendingFromTranslationCard"
              style="--padding-start: 12px; --padding-end: 12px"
            >
              <!-- LOADING STATE -->
              <ng-container *ngIf="isSendingFromTranslationCard">
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    animation: pulse 1.5s ease-in-out infinite;
                  "
                >
                  <ion-spinner
                    name="crescent"
                    style="width: 16px; height: 16px"
                  ></ion-spinner>
                  <span>Sending...</span>
                </div>
              </ng-container>

              <!-- NORMAL STATE -->
              <ng-container *ngIf="!isSendingFromTranslationCard">
                <div style="display: flex; align-items: center; gap: 4px">
                  <ion-icon
                    name="send-outline"
                    style="font-size: 16px"
                  ></ion-icon>
                  <span>Send</span>
                </div>
              </ng-container>
            </ion-button>
          </div>
        </div>
      </ion-col>

      <!-- ‚úÖ UPDATED: Disabled when translation card is visible -->
      <ion-col size="auto" style="display: flex; align-items: center">
        <!-- ‚úÖ MIC BUTTON (when no text) -->
 <ion-button *ngIf="!showSendButton" class="mic-button" shape="round"
          [disabled]="iBlocked || translationCard?.visible" (touchstart)="startRecording($event)"
          (touchmove)="onRecordingTouchMove($event)" (touchend)="stopRecording()" (touchcancel)="cancelRecording()"
          (mousedown)="startRecording($event)" (mouseup)="stopRecording()" [class.recording]="isRecording">
          <ion-icon slot="icon-only" name="mic"></ion-icon>
        </ion-button>

        <!-- ‚úÖ SEND BUTTON WITH SPINNER -->
        <ion-button
          *ngIf="showSendButton"
          fill="clear"
          class="send-btn"
          shape="round"
          (click)="sendMessage()"
          [disabled]="iBlocked || translationCard?.visible || isSending"
          [style.opacity]="translationCard?.visible || isSending ? '0.5' : '1'"
          [style.pointer-events]="isSending ? 'none' : 'auto'"
        >
          <!-- ‚úÖ Show spinner when sending -->
          <ion-spinner
            *ngIf="isSending"
            name="crescent"
            slot="icon-only"
            style="--color: white"
          ></ion-spinner>

          <!-- ‚úÖ Show send icon when not sending -->
          <ion-icon *ngIf="!isSending" slot="icon-only" name="send"></ion-icon>
        </ion-button>
      </ion-col>
    </ion-row>
  </div>
</div>
<!-- ========================= -->

<!-- üé§ Recording Overlay (shown when not in preview mode) -->
<div class="recording-overlay" *ngIf="isRecording && !showRecordingPreview">
  <div class="recording-content">
    <div class="recording-timer">
      <div class="recording-pulse"></div>
      <span class="recording-time">{{ recordingTime }}</span>
    </div>
    <div class="recording-actions">
      <ion-button fill="clear" color="danger" (click)="cancelRecording()">
        <!-- class="cancel-recordingz-btn" -->

        <!-- <ion-icon name="close-circle" slot="start"></ion-icon> -->
      </ion-button>
      <div class="slide-cancel-hint">
        <ion-icon name="arrow-back-outline"></ion-icon>
        <span>Slide left to cancel</span>
      </div>
    </div>
  </div>
</div>

<!-- üé§ WhatsApp-style Recording Preview -->
<div class="recording-preview-overlay" [class.paused]="isRecordingPaused" *ngIf="showRecordingPreview">

  <div class="recording-preview-container">

    <!-- First Row: Timer and Waveform -->
<div class="recording-preview-row-1">

  <!-- ‚ñ∂Ô∏è LISTEN PLAY / PAUSE (ONLY AFTER RECORDING) -->
<ion-button
  *ngIf="recordingPhase !== 'recording'"
  fill="outline"
  size="small"
  class="preview-listen-btn"
  (click)="toggleListen()"
>
  <ion-icon
    [name]="recordingPhase === 'listening' ? 'pause' : 'play'"
    slot="icon-only">
  </ion-icon>
</ion-button>

  <div class="waveform-container">
    <div class="waveform"
      [class.recording]="isRecording && !isRecordingPaused"
      [class.playing]="recordingPhase === 'listening'">
      <div class="waveform-bar"
        *ngFor="let i of [].constructor(40)">
      </div>
    </div>
  </div>
    <div class="recording-preview-timer">
    <span class="timer-text">{{ recordingTime }}</span>
  </div>
</div>

    <!-- Second Row: Delete, Play, Send -->
    <div class="recording-preview-row-2">

      <ion-button fill="clear" color="danger" (click)="deleteRecordingPreview()" class="preview-delete-btn">
        <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
      </ion-button>

<!-- üéô RECORD PAUSE / RESUME (ONLY WHILE RECORDING) -->
<ion-button
  fill="solid"
  color="medium"
  class="preview-record-control-btn"
  (click)="recordingPhase === 'recording' ? pauseRecording() : resumeRecording()"
>
  <ion-icon
    name="mic"
    slot="icon-only">
  </ion-icon>
</ion-button>

      <ion-button fill="clear" color="primary" (click)="sendRecordingFromPreview()" class="preview-send-btn">
        <ion-icon name="send" slot="icon-only"></ion-icon>
      </ion-button>
    </div>

    <!-- Hidden audio element for playback (only when recording is stopped) -->
   <audio
  #previewAudio
  *ngIf="selectedAttachment?.type === 'audio' && !isRecording"
  [src]="selectedAttachment?.previewUrl"
  (loadedmetadata)="onPreviewLoadedMetadata()"
  (timeupdate)="onPreviewTimeUpdate()"
  (ended)="onPreviewEnded()"
  style="display:none">
</audio>
  </div>
</div>

<ion-popover
  [isOpen]="showPopover"
  [event]="popoverEvent"
  (didDismiss)="showPopover = false"
  style="--width: 300px; --height: 400px"
>
  <ng-template>
    <ion-datetime
      presentation="date"
      (ionChange)="onDateSelected($event)"
      [value]="selectedDate"
      [max]="maxDate"
      showDefaultButtons="true"
    ></ion-datetime>
  </ng-template>
</ion-popover>
<!-- üé§ MICROPHONE PERMISSION PROMPT -->
<ion-alert
  [isOpen]="showMicPermissionPrompt"
  header="Microphone Access Required"
  message="Allow microphone access to record voice messages."
  [buttons]="micPermissionButtons"
  backdropDismiss="false"
></ion-alert>


