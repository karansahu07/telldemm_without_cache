<ion-header class="chat-header" [translucent]="true">
  <ion-toolbar>
    <ng-container *ngIf="selectedMessages.length > 0; else defaultHeader">
      <ion-title>{{ selectedMessages.length }} selected</ion-title>
      <ion-buttons slot="end">
        <!-- ‚úÖ Only 1 Text Message -->
        <ng-container *ngIf="isOnlyOneTextMessage()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="copySelectedMessages()">
            <ion-icon name="copy-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="replyToMessages()">
            <ion-icon name="return-up-back-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="onMore($event)">
            <ion-icon name="ellipsis-vertical-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- ‚úÖ Multiple Text Messages -->
        <ng-container *ngIf="isMultipleTextMessages()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="copySelectedMessages()">
            <ion-icon name="copy-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- ‚úÖ Only 1 Attachment -->
        <ng-container *ngIf="isOnlyOneAttachment()">
          <ion-button (click)="replyToMessages()">
            <ion-icon name="return-up-back-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="onMore($event)">
            <ion-icon name="ellipsis-vertical-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- ‚úÖ Multiple Attachments -->
        <ng-container *ngIf="isMultipleAttachments()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- ‚úÖ Mixed: text + attachment -->
        <ng-container *ngIf="isMixedSelection()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ng-container>
      </ion-buttons>
    </ng-container>

    <!-- üîÅ Default Chat Header -->
    <ng-template #defaultHeader>
      <ion-buttons
        *ngIf="!showSearchBar"
        slot="start"
        style="color: black; width: 8%; margin-top: 15px"
      >
        <ion-back-button (click)="onBack()"></ion-back-button>
        <!-- <ion-icon name="arrow-back-outline" class="back-icon"></ion-icon> -->
      </ion-buttons>

      <ng-container *ngIf="!showSearchBar; else searchBar">
        <ion-buttons>
          <ion-item
            lines="none"
            style="
              --padding-start: 0;
              --background: white;
              color: black;
              margin-top: 15px;
            "
            detail="false"
          >
            <ion-avatar style="margin-left: 10px" slot="start">
              <img
                [src]="currentConv?.avatar || 'assets/images/default-avatar.png'"
                alt="User Avatar"
                (error)="setDefaultAvatar($event)"
              />
            </ion-avatar>
            <ion-label
              (click)="goToProfile()"
              style="
                width: auto;
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                cursor: pointer;
              "
            >
              <h2>{{ currentConv?.title||"Chat title" }}</h2>

              <!-- ---- Presence & Typing Status ---- -->
              <div
                style="
                  font-size: 12px;
                  margin-top: 4px;
                  display: flex;
                  align-items: center;
                  gap: 4px;
                "
              >
                <!-- Private Chat -->
                <ng-container *ngIf="currentConv?.type === 'private'">
                  <!-- üÜï Show typing first if user is typing -->
                  <ng-container *ngIf="isReceiverTyping; else presenceBlock">
                    <span style="color: var(--ion-color-success)"
                      >typing...</span
                    >
                  </ng-container>

                  <!-- Otherwise show online/last seen -->
                  <ng-template #presenceBlock>
                    <ng-container
                      *ngIf="receiverStatus === 'online'; else lastSeenTpl"
                    >
                      <span class="online-dot" aria-hidden="true"></span>
                      <span style="color: var(--ion-color-success)"
                        >Online</span
                      >
                    </ng-container>

                    <ng-template #lastSeenTpl>
                      <span
                        style="color: var(--ion-color-medium)"
                        *ngIf="lastSeenTime"
                      >
                        {{ lastSeenTime }}
                      </span>
                    </ng-template>
                  </ng-template>
                </ng-container>

                <!-- Group Chat -->
                <ng-container *ngIf="currentConv?.type === 'group'">
                  <!-- üÜï Show typing count if anyone is typing -->
                  <ng-container
                    *ngIf="typingCount > 0; else groupPresenceBlock"
                  >
                    <span style="color: var(--ion-color-success)">
                      {{ typingCount }} {{ typingCount === 1 ? 'person' :
                      'people' }} typing...
                    </span>
                  </ng-container>

                  <!-- Otherwise show member count -->
                  <ng-template #groupPresenceBlock>
                    <span style="color: var(--ion-color-medium)">
                      {{ currentConv?.members?.length || 0 }} members
                    </span>
                  </ng-template>
                </ng-container>
              </div>
            </ion-label>
          </ion-item>
        </ion-buttons>
      </ng-container>

      <ng-template #searchBar>
        <ion-item
          lines="none"
          style="
            margin-top: 10px;
            padding: 10px 15px;
            --border-radius: 25px;
            --background: #f5f5f5;
            width: 100%;
          "
        >
          <ion-icon
            name="arrow-back-outline"
            slot="start"
            style="font-size: 24px; cursor: pointer; margin-right: 10px"
            (click)="cancelSearch()"
          ></ion-icon>
          <ion-input
            placeholder="Search messages..."
            [(ngModel)]="searchText"
            (ionInput)="onSearchInput()"
            style="margin-left: 10px; flex: 1"
          >
          </ion-input>
          <ion-buttons slot="end">
            <!-- <ion-button (click)="openDatePicker()">
            <ion-icon name="calendar-outline"></ion-icon>
          </ion-button> -->
            <ion-button (click)="openPopover($event)">
              <ion-icon name="calendar-outline"></ion-icon>
            </ion-button>
            <ion-button (click)="navigateSearch('up')">
              <ion-icon name="arrow-up-outline"></ion-icon>
            </ion-button>
            <ion-button (click)="navigateSearch('down')">
              <ion-icon name="arrow-down-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-item>
      </ng-template>

      <ion-buttons *ngIf="!showSearchBar" slot="end" style="margin-top: 15px">
        <!-- <ion-button style="color: black">
          <ion-icon name="videocam-outline" style="font-size: 35px"></ion-icon>
        </ion-button> -->
        <ion-button style="color: black" class="chat_ion_button">
          <ion-icon
            name="videocam-outline"
            style="font-size: 35px"
            class="chatting_head_icons"
          ></ion-icon>
        </ion-button>
        <!-- <ion-button (click)="goToCallingScreen()" style="color: black">
          <ion-icon name="call-outline" style="font-size: 28px"></ion-icon>
        </ion-button> -->
        <ion-button (click)="goToCallingScreen()" style="color: black" class="chat_ion_button">
          <ion-icon
            name="call-outline"
            style="font-size: 28px"
            class="chatting_head_icons"
          ></ion-icon>
        </ion-button>
        <!-- <ion-button (click)="openOptions($event)" style="color: black"> -->
          <ion-button (click)="openOptions($event)" style="color: black" class="chat_ion_button">
          <ion-icon
            name="ellipsis-vertical-outline"
            style="font-size: 28px"
            class="chatting_head_icons"
          ></ion-icon>
        </ion-button>
      </ion-buttons>
    </ng-template>
  </ion-toolbar>
</ion-header>

<ion-content class="chat-background" [fullscreen]="true" [scrollEvents]="true">
  <!-- Pinned Message Banner (Alternative/Mobile View) -->
  <div class="fordark"><img src="/assets/images/chat_bg.jpg" alt="" /></div>

  <div
    #scrollContainer
    class="chat-messages"
    style="padding: 10px 10px 10px 10px; overflow-y: auto; min-height: 100%"
  >
    <!-- System block/unblock bubbles (only visible to blocker) -->
    <div
      *ngIf="showBlockBubble"
      class="system-bubble-wrapper"
      style="display: flex; justify-content: center; margin: 10px 0"
    >
      <div class="system-bubble" (click)="unblockFromChat()">
        You blocked this contact. Tap to unblock.
      </div>
    </div>

    <div
      *ngIf="showUnblockBubble"
      class="system-bubble-wrapper"
      style="display: flex; justify-content: center; margin: 10px 0"
    >
      <div class="system-bubble system-bubble-success">
        You unblocked this contact.
      </div>
    </div>

    <ion-spinner
      name="dots"
      *ngIf="isLoadingMore"
      style="margin: 8px auto; display: block"
    ></ion-spinner>

    <div *ngFor="let group of groupedMessages">
      <div class="date-divider" [id]="'date-group-' + group.date">
        <div class="text-bg-white date-label">{{ group.date }}</div>
      </div>

      <ng-container *ngFor="let msg of group.messages">
        <div
          class="msg-row"
          [ngClass]="{
       'align-end': msg.sender_id === senderId,
       'align-start': msg.sender_id !== senderId,
       'selected': isSelected(msg),
       'pinned-message-highlight': pinnedMessage && pinnedMessage.messageId === msg.message_id
     }"
          *ngIf="!isMessageHiddenForUser(msg)"
          style="display: flex; flex-direction: column; margin: 5px 0"
          (touchstart)="startLongPress(msg)"
          (touchend)="cancelLongPress()"
          (touchmove)="cancelLongPress()"
          (click)="onMessageClick(msg)"
        >
          <!-- ===== MESSAGE BUBBLE ===== -->
          <div
            class="message-bubble"
            (click)="openAttachmentModal(msg)"
            [attr.data-msg-key]="msg.msgId"
            [class.my-message]="msg.isMe"
            [ngClass]="[
        msg.isMe ? 'sender-message' : 'receiver-message',
        msg.fadeOut ? 'fade-out' : ''
       ]"
          >
            <!-- Forwarded Label -->
            <div *ngIf="msg.isForwarded" class="forwarded-label">
              <ion-icon
                name="arrow-undo-outline"
                class="forwarded-icon"
              ></ion-icon>
              Forwarded
            </div>

            <!-- Group Sender Name -->
            <span
              *ngIf="chatType === 'group' && msg.sender_id !== senderId"
              style="font-size: 12px; color: #6c6c6c; margin-left: 5px"
            >
              {{ msg.sender_name }}
            </span>

            <!-- Replied Message -->
        <div
              class="replied-message"
              *ngIf="msg.replyToMsgId"
              (click)="scrollToRepliedMessage(msg.replyToMsgId)"
            >
              <ng-container
                *ngIf="getRepliedMessage(msg.replyToMsgId) as repliedMsg"
              >
                <div
                  class="replied-container"
                  (click)="scrollToRepliedMessage(msg.replyToMsgId)"
                >
                  <div class="replied-header">
                    <ion-icon
                      name="arrow-undo-outline"
                      class="reply-icon"
                    ></ion-icon>
                    <span class="replied-sender">
                      {{ repliedMsg.isMe ? 'You' : repliedMsg.sender }}
                    </span>
                  </div>
                  <div class="replied-content">
                    <div class="replied-text" *ngIf="repliedMsg.text">
                      {{ getReplyPreviewText(repliedMsg) }}
                    </div>
                    <div
                      class="replied-attachment"
                      *ngIf="repliedMsg.attachment"
                    >
                      <ion-icon name="attach-outline"></ion-icon>
                      {{ getReplyPreviewText(repliedMsg) }}
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>

          <!-- Normal Message -->
<ng-container *ngIf="!msg.isDeleted">

 <!-- If no attachment and has text -->
<ng-container *ngIf="!msg.attachment && msg.text">

  <!-- SIMPLE TRANSLATION BAR (only toggle button, if translations exist) -->
  <div 
    class="translation-bar" 
    *ngIf="msg.translations && hasMultipleTranslations(msg)" 
    (click)="$event.stopPropagation()"
    style="
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 8px;
      background: rgba(0,0,0,0.05);
      border-radius: 6px 6px 0 0;
      font-size: 11px;
    "
  >
    <div style="color: #666;">
      <small *ngIf="getActiveTranslationLabel(msg) as activeLabel">
        {{ activeLabel }}
      </small>
    </div>

    <!-- Simple Toggle Button -->
    <button
  (click)="cycleTranslation(msg); $event.stopPropagation()"
  title="Translate"
  aria-label="Translate"
  style="
    background: transparent;
    border: none;
    font-size: 18px;
    cursor: pointer;
    padding: 2px 6px;
    color: #3880ff;
    display: flex;
    align-items: center;
  "
>
  <ion-icon name="language-outline"></ion-icon>
</button>

  </div>

  <!-- VISIBLE TEXT (active translation) -->
  <ion-text class="message-text" (click)="$event.stopPropagation()">
    {{ getDisplayedText(msg) }}
  </ion-text>

</ng-container>

  <!-- Attachments (keep existing attachment markup unchanged) -->
  <ng-container *ngIf="msg.attachment">
    <!-- existing attachment markup ‚Äî keep as before -->
    <img
      *ngIf="msg.attachment.type === 'image'"
      [src]="msg.attachment.previewUrl"
      alt="Image"
      style="max-width: 200px; border-radius: 10px; margin: 5px 0"
    />
    <video
      *ngIf="msg.attachment.type === 'video'"
      controls
      style="max-width: 200px; border-radius: 10px; margin: 5px 0"
    >
      <source
        [src]="msg.attachment.previewUrl"
        [type]="msg.attachment.mimeType || 'video/mp4'"
      />
    </video>
    <audio
      *ngIf="msg.attachment.type === 'audio'"
      controls
      style="margin: 5px 0"
    >
      <source
        [src]="msg.attachment.previewUrl"
        [type]="msg.attachment.mimeType || 'audio/mpeg'"
      />
    </audio>
    <div *ngIf="msg.attachment.type === 'file'" style="margin: 5px 0">
      <ion-icon name="document-outline" style="margin-right: 5px"></ion-icon>
      <a
        [href]="msg.attachment.previewUrl"
        [download]="msg.attachment.fileName || 'file'"
        target="_blank"
        rel="noopener"
      >
        {{ msg.attachment.fileName || 'Download File' }}
      </a>
    </div>

    <ion-text class="message-text" *ngIf="msg.text" style="margin-top: 5px">
      {{ msg.text }}
    </ion-text>
  </ng-container>

</ng-container>


            <!-- Timestamp -->
            <p class="time-stamp status-container">
              <ion-icon
                *ngIf="msg.isPinned"
                name="pin"
                class="pin-indicator-timestamp"
              ></ion-icon>
              {{ msg.time }}
              <span
                *ngIf="msg.isEdit"
                style="font-size: 11px; color: gray; margin-left: 4px"
                >(edited)</span
              >
              <ng-container
                *ngIf="getStatusIconDescriptorByMsgId(msg.msgId) as icon"
              >
                <ion-icon
                  [name]="icon.name"
                  [ngClass]="icon.cls"
                  [attr.title]="icon.title"
                ></ion-icon>
              </ng-container>
            </p>

            <!-- üü° COMPACT REACTION BADGE (WhatsApp style) -->
            <div
              class="reaction-badges"
              *ngIf="getReactionBadges(msg).length > 0"
              [class.right]="msg.sender_id === senderId"
              [class.left]="msg.sender_id !== senderId"
            >
              <div
                class="badge"
                *ngFor="let b of msg.reactions"
                [class.mine]="b.userId == senderId"
                (click)="onReactionBadgeClick($event, msg, b)"
              >
                <span class="emoji">{{ b.emoji }}</span>
                <span class="cnt" *ngIf="getReactionsCount(msg)>1">
                  {{ getReactionsCount(msg) }}
                </span>
              </div>
            </div>
          </div>

          <!-- üü¢ FLOATING REACTION BAR -->
          <div
            class="reaction-bar"
            *ngIf="isQuickReactionOpen(msg)"
            [class.right]="msg.sender_id === senderId"
            [class.left]="msg.sender_id !== senderId"
          >
            <button class="react-btn" (click)="addReaction(msg, 'üëç')">
              üëç
            </button>
            <button class="react-btn" (click)="addReaction(msg, '‚ù§Ô∏è')">
              ‚ù§Ô∏è
            </button>
            <button class="react-btn" (click)="addReaction(msg, 'üòÇ')">
              üòÇ
            </button>
            <button class="react-btn" (click)="addReaction(msg, 'üòÆ')">
              üòÆ
            </button>
            <button class="react-btn" (click)="addReaction(msg, 'üò¢')">
              üò¢
            </button>
            <button class="react-btn" (click)="addReaction(msg, 'üôè')">
              üôè
            </button>
            <button class="react-btn more" (click)="openEmojiKeyboard(msg)">
              Ôºã
            </button>
            <!-- <h2> Reaction emojis here</h2> -->
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</ion-content>

<ion-modal [isOpen]="showPreviewModal" (didDismiss)="showPreviewModal = false">
  <ng-template>
    <ion-header [translucent]="true" class="model-header">
      <ion-toolbar class="model-toll">
        <ion-buttons slot="start">
          <!-- <ion-button (click)="cancelAttachment()">Cancel</ion-button> -->
          <ion-icon
            (click)="cancelAttachment()"
            name="close"
            style="font-size: 25px"
          ></ion-icon>
        </ion-buttons>

        <ion-buttons slot="end" class="pre-icons">
          <img src="assets/images/hd.png" alt="hd" />
          <ion-icon name="happy-outline" style="font-size: 24px"></ion-icon>
          <img src="assets/images/text.png" alt="text" />
          <img src="assets/images/pencil.png" alt="pencil" />
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="">
      <div class="pre-model">
        <div class="mine2">
          <div *ngIf="selectedAttachment?.type === 'image'">
            <img [src]="selectedAttachment?.previewUrl" class="preview-image" />
          </div>

          <div *ngIf="selectedAttachment?.type === 'video'">
            <video
              controls
              [src]="selectedAttachment?.previewUrl"
              class="preview-video"
            ></video>
          </div>

          <div *ngIf="selectedAttachment?.type === 'file'" class="preview-file">
            <ion-icon
              name="document-attach-outline"
              style="font-size: 48px"
            ></ion-icon>
            <p>{{ selectedAttachment?.fileName }}</p>
          </div>
        </div>

        <div class="mine ion-padding">
          <ion-textarea
            [(ngModel)]="messageText"
            placeholder="Type your message here..."
            class="pre-message"
          ></ion-textarea>

          <div class="sendbtn">
            <p>{{ receiver_name }}</p>
            <!-- <ion-icon
              name="send-outline"
              (click)="sendMessage()"
              class="mediasend"
            ></ion-icon> -->

            <ion-icon
              name="send-outline"
              (click)="sendMessage()"
              class="mediasend"
              [class.sending]="isSending"
              [style.pointer-events]="isSending ? 'none' : 'auto'"
              [style.opacity]="isSending ? '0.5' : '1'"
            >
            </ion-icon>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- ‚úÖ Message Input Footer -->
<!-- ========================= -->
<!-- Message Input Footer (updated) -->
<div class="footer-fixed">
  <!-- Normal footer: typing indicator, reply preview, input row -->
  <div *ngIf="!iBlocked">
    <!-- ‚úÖ UPDATED: Typing indicator (above keyboard) -->
    <div
      class="typing-indicator-wrapper"
      *ngIf="isReceiverTyping || typingCount > 0"
    >
      <!-- PRIVATE CHAT layout -->
      <div
        *ngIf="currentConv?.type === 'private' && isReceiverTyping"
        class="typing-indicator-content private"
      >
        <div
          class="typing-dots center-only"
          aria-hidden="true"
          role="status"
          aria-label="typing"
        >
          <span class="dot"></span><span class="dot"></span
          ><span class="dot"></span>
        </div>
      </div>

      <!-- GROUP CHAT layout -->
      <div
        *ngIf="currentConv?.type === 'group' && typingCount > 0"
        class="typing-indicator-content group"
      >
        <div class="typing-text">
          <div class="typing-avatars">
            <!-- Single user typing -->
            <ng-container *ngIf="typingCount === 1 && typingUsers.length >= 1">
              <img
                class="typing-avatar single"
                [src]="typingUsers[0].avatar || 'assets/images/default-avatar.png'"
                (error)="setDefaultAvatar($event)"
                [alt]="typingUsers[0].name || 'User'"
              />
            </ng-container>

            <!-- Multiple users typing -->
            <ng-container *ngIf="typingCount >= 2">
              <div class="avatar-stack">
                <img
                  *ngFor="let u of typingUsers.slice(0,3); let i = index"
                  class="typing-avatar stacked idx-{{i}}"
                  [src]="u.avatar || 'assets/images/default-avatar.png'"
                  (error)="setDefaultAvatar($event)"
                  [alt]="u.name || 'User'"
                />
                <div class="more-badge" *ngIf="typingCount > 3">
                  +{{ typingCount - 3 }}
                </div>
              </div>
            </ng-container>
          </div>
        </div>

        <div
          class="typing-dots"
          aria-hidden="true"
          role="status"
          aria-label="typing"
        >
          <span class="dot"></span><span class="dot"></span
          ><span class="dot"></span>
        </div>
      </div>
    </div>
    <!-- ========================= -->

    <!-- REPLY PREVIEW -->
    <div class="reply-preview" *ngIf="replyToMessage">
      <div class="reply-header">
        <span class="reply-to-text"
          >Replying to {{ replyTo?.sender?.username || "You"}}</span
        >
        <ion-button fill="clear" size="small" (click)="cancelReply()">
          <ion-icon name="close" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
      <div class="reply-content">
        <div class="reply-line"></div>
        <div class="reply-message">
          {{ getReplyPreviewText(replyToMessage) }}
        </div>
      </div>
    </div>

<!-- INPUT ROW -->
<!-- INPUT ROW -->
<ion-row class="footer-row" style="align-items: center">
  <ion-col
    class="message-input-container"
    style="display: flex; flex-direction: column; align-items: stretch; gap: 8px"
  >
    <div style="display: flex; align-items: center; gap: 8px">
      <ion-icon
        name="document-text-outline"
        class="icon-left"
        (click)="openKeyboard()"
      ></ion-icon>

      <ion-textarea
        [disabled]="iBlocked"
        [autoGrow]="true"
        [(ngModel)]="messageText"
        placeholder="Message"
        (ionInput)="onMessageInput($event)"
        (ionFocus)="onInputFocus()"
        (ionBlur)="onInputBlur()"
        (keyup.enter)="sendMessage()"
        class="message-input"
      ></ion-textarea>

      <ion-icon
        name="attach-outline"
        (click)="pickAttachment()"
        class="icon-right"
        [hidden]="iBlocked"
      ></ion-icon>
      <ion-icon
        name="camera-outline"
        class="icon-right"
        (click)="openCamera()"
        [hidden]="iBlocked"
      ></ion-icon>
    </div>

   <!-- üåê Translation Options (Updated) -->
<!-- üåê Translation Options (Updated) -->
<div
  *ngIf="showTranslationOptions"
  class="translation-options"
  style="
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f5f5f5;
    border-radius: 12px;
    padding: 6px 10px;
    margin-top: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    gap: 8px;
  "
>
  <!-- ‚úÖ Custom Language Dropdown -->
  <ion-select
    interface="popover"
    placeholder="Translate to..."
    (ionChange)="onSelectTranslateLanguage($event)"
    [disabled]="isTranslatingCustom || isTranslatingToReceiver"
    style="flex: 1; max-width: 60%;"
  >
    <ion-select-option *ngFor="let lang of languagesList" [value]="lang">
      {{ lang.label }}
    </ion-select-option>
  </ion-select>

  <!-- ‚úÖ Translate to Receiver Button -->
  <ion-button
    size="small"
    fill="outline"
    color="medium"
    (click)="translateTo('receiver')"
    [disabled]="isTranslatingCustom || isTranslatingToReceiver"
    style="flex: 1; --padding-start: 8px; --padding-end: 8px;"
  >
    <ion-spinner 
      *ngIf="isTranslatingToReceiver" 
      name="crescent" 
      slot="start"
      style="width: 14px; height: 14px;"
    ></ion-spinner>
    <!-- <span *ngIf="!isTranslatingToReceiver" style="font-size: 11px;">
      To Receiver
    </span> -->
    <span *ngIf="!isTranslatingToReceiver" style="font-size: 11px;">
      Demmlang ({{receiverLangLabel}})
    </span>
    <span *ngIf="isTranslatingToReceiver" style="font-size: 11px;">
      Translating...
    </span>
  </ion-button>
</div>

<!-- üåê TRANSLATION CARD (Simplified & Cleaner) - Shows up to 3 translations -->
<div
  *ngIf="translationCard?.visible"
  class="translation-card"
  role="region"
  aria-label="Translation preview"
  style="
    background: white;
    border-radius: 12px;
    padding: 12px;
    margin-top: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 3px solid #3880ff;
  "
>
  <!-- CARD HEADER -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <div style="display: flex; align-items: center; gap: 6px;">
      <ion-icon name="language-outline" style="font-size: 18px; color: #3880ff;"></ion-icon>
      <strong style="font-size: 13px; color: #333;">
        <!-- {{ translationCard?.items?.length }} Translation{{ translationCard?.items?.length > 1 ? 's' : '' }} Ready -->
          <ng-container *ngIf="translationCard?.items?.length as count">
  <strong style="font-size: 13px; color: #333;">
    {{ count }} Translation{{ count > 1 ? 's' : '' }} Ready
  </strong>
</ng-container>

<!-- Fallback (if items is empty or undefined) -->
<ng-container *ngIf="!(translationCard?.items?.length)">
  <strong style="font-size: 13px; color: #333;">
    0 Translations Ready
  </strong>
</ng-container>

      </strong>
    </div>
    <small style="color: #666; font-size: 11px;">
      {{ translationCard?.createdAt | date: 'shortTime' }}
    </small>
  </div>

  <!-- CARD BODY - All Translations -->
  <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px;">
    <div
      *ngFor="let t of (translationCard?.items || []); let i = index"
      style="
        background: #f8f9fa;
        border-radius: 8px;
        padding: 8px 10px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      "
      [style.border-left]="i === 0 ? '3px solid #28a745' : (t.label.includes('Receiver') ? '3px solid #ff6b6b' : '3px solid #3880ff')"
    >
      <!-- Language Label & Code -->
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 11px; font-weight: 600;" 
              [style.color]="i === 0 ? '#28a745' : (t.label.includes('Receiver') ? '#ff6b6b' : '#3880ff')">
          {{ t.label }}
        </span>
        <span style="
          font-size: 10px;
          background: #e0e0e0;
          padding: 2px 6px;
          border-radius: 4px;
          color: #666;
        ">
          {{ t.code }}
        </span>
      </div>
      
      <!-- Translated Text -->
      <div style="font-size: 13px; color: #333; line-height: 1.4;">
        {{ t.text }}
      </div>
    </div>

    <!-- EMPTY STATE -->
    <div
      *ngIf="!(translationCard?.items?.length)"
      style="text-align: center; padding: 12px; color: #999; font-size: 12px;"
    >
      No translations available
    </div>
  </div>

  <!-- CARD ACTIONS -->
  <div style="display: flex; justify-content: flex-end; gap: 8px;">
    <ion-button 
      size="small" 
      fill="clear" 
      color="medium"
      (click)="closeTranslationCard()"
      style="--padding-start: 10px; --padding-end: 10px;"
    >
      Cancel
    </ion-button>
    <ion-button 
      size="small" 
      color="primary" 
      (click)="sendFromTranslationCard()"
      style="--padding-start: 12px; --padding-end: 12px;"
    >
      <ion-icon name="send-outline" slot="start" style="font-size: 16px;"></ion-icon>
      Send
    </ion-button>
  </div>
</div>

<!-- üåê TRANSLATION CARD (Simplified & Cleaner) -->


  </ion-col>

  <ion-col size="auto" style="display: flex; align-items: center">
    <ion-button
      *ngIf="!showSendButton"
      class="mic-button"
      shape="round"
      [disabled]="iBlocked"
    >
      <ion-icon slot="icon-only" name="mic"></ion-icon>
    </ion-button>

    <ion-button
      *ngIf="showSendButton"
      fill="clear"
      class="send-btn"
      shape="round"
      (click)="sendMessage()"
      [disabled]="iBlocked"
    >
      <ion-icon slot="icon-only" name="send"></ion-icon>
    </ion-button>
  </ion-col>
</ion-row>
  </div>
</div>
<!-- ========================= -->

<ion-popover
  [isOpen]="showPopover"
  [event]="popoverEvent"
  (didDismiss)="showPopover = false"
  style="--width: 300px; --height: 400px"
>
  <ng-template>
    <ion-datetime
      presentation="date"
      (ionChange)="onDateSelected($event)"
      [value]="selectedDate"
      showDefaultButtons="true"
    ></ion-datetime>
  </ng-template>
</ion-popover>
