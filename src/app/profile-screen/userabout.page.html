<ion-header [translucent]="true" [class.scrolled]="isScrolled">

  <ion-toolbar style="padding-top: 30px;">

    <ion-button slot="start" fill="clear" (click)="goBackToChat()" class="backbutton">
      <ion-icon name="arrow-back-outline" class="back-icon"></ion-icon>
    </ion-button>

    <ion-button slot="end" fill="clear" (click)="openMenu($event)" class="dotbutton">
      <ion-icon name="ellipsis-vertical" class="dot-icon"></ion-icon>
    </ion-button>

    <div class="profile-container">
      <!-- <ion-avatar class="profile-avatar" (click)="openProfileDp()">
        <img src="assets/images/user.jfif" alt="Profile Picture" />
      </ion-avatar> -->
      <ion-avatar class="profile-avatar" (click)="openProfileDp()">
        <img [src]="receiverProfile || 'assets/images/user.jfif'" alt="Profile Picture"
          (error)="setDefaultAvatar($event)" />
      </ion-avatar>

      <ion-label class="profile-name"> <h2>{{ chatTitle }}</h2></ion-label>
       
    </div>
    
  </ion-toolbar>

</ion-header>

<ion-content [[fullscreen]="true" (ionScroll)="onScroll($event)" scrollEvents="true">
  <div class="center-content">
    <ion-label class="username">
      {{ chatTitle}}
    </ion-label>

    <ion-label class="usernumber" *ngIf="chatType === 'group'">
    {{ groupMembers.length }} {{ 'userabout.members' | translate }}
  </ion-label>
  </div>

  <!-- Social Media Links -->
  <div class="social-links" *ngIf="socialMediaLinks.length > 0">
    <ion-list lines="none">
      <ion-item *ngFor="let link of socialMediaLinks" button detail="false"
        (click)="openExternalLink(link.profile_url)">
        <ion-icon [name]="link.platform.toLowerCase() === 'instagram' ? 'logo-instagram' 
                      : link.platform.toLowerCase() === 'linkedin' ? 'logo-linkedin'
                      : 'link-outline'" slot="start"></ion-icon>
        <ion-label>
          <h3>{{ link.platform }}</h3>
          <p>{{ link.profile_url }}</p>
        </ion-label>
      </ion-item>
    </ion-list>
  </div>


  <!-- Common Message Toolbar -->
  <div class="message-toolbar" style="margin-top: 15px; margin-bottom: 15px;">
    <div class="message-item" *ngIf="chatType === 'private'" (click)="goBackToChat()">
      <ion-avatar class="centered-avatar">
        <ion-icon name="chatbox-ellipses-outline" class="mess-icon"></ion-icon>
      </ion-avatar>
      <ion-label>{{ 'userabout.toolbar.message' | translate }}</ion-label>
    </div>

    <div class="message-item">
      <ion-avatar class="centered-avatar">
        <ion-icon name="call-outline" class="mess-icon"></ion-icon>
      </ion-avatar>
      <ion-label>{{ 'userabout.toolbar.call' | translate }}</ion-label>
    </div>

    <div class="message-item">
      <ion-avatar class="centered-avatar">
        <ion-icon name="videocam-outline" class="mess-icon"></ion-icon>
      </ion-avatar>
      <ion-label>{{ 'userabout.toolbar.video' | translate }}</ion-label>
    </div>

    <div class="message-item" *ngIf="chatType === 'group'" (click)="onAddMember()">
      <ion-avatar class="centered-avatar">
        <ion-icon name="person-add-outline" class="all-icon1"></ion-icon>
      </ion-avatar>
      <ion-label>{{ 'userabout.toolbar.add' | translate }}</ion-label>
    </div>
  </div>


  <!-- Private Chat Static Message -->
  <!-- <div class="what-mess" *ngIf="chatType === 'private'">
    <p class="messgae-chat">Hey there! I am using WhatsApp.</p>
    <p class="message-number">23 March 2024</p>
  </div> -->

  <!-- PRIVATE CHAT DESCRIPTION -->
  <!-- ✅ PRIVATE CHAT DESCRIPTION -->
  <!-- Group / Private Description Block -->
  <!-- <div class="what-mess" *ngIf="chatType === 'group' || chatType === 'private'">
  <p class="messgae-chat" *ngIf="chatType === 'private'">
    {{ receiverAbout || 'Hey there! I am using Telldemm.' }}
  </p>

  <ng-container *ngIf="chatType === 'group'">
  <p class="messgae-chat" (click)="openGroupDescriptionPage()">
    {{ groupDescription || 'No group description.' }}
  </p>
  <p class="message-number">
    Created by {{ groupCreatedBy || 'Unknown' }} on
    {{ groupCreatedAt ? (groupCreatedAt | date: 'dd MMMM yyyy, h:mm a') : 'Unknown Date' }}
  </p>
</ng-container>

</div> -->

  <div class="what-mess" *ngIf="chatType === 'group' || chatType === 'private'">
    <ng-container *ngIf="chatType === 'private'">
      <p class="messgae-chat">
        {{ receiverAbout || ('userabout.defaults.heyThere' | translate) }}
      </p>
      <p class="status-time" *ngIf="statusTime">
        {{ 'userabout.updatedOn' | translate }} {{ statusTime | date:'dd MMM yyyy, h:mm a' }}
      </p>
    </ng-container>

    <ng-container *ngIf="chatType === 'group'">
      <p class="messgae-chat" (click)="openGroupDescriptionPage()">
        {{ groupDescription || ('userabout.defaults.noGroupDescription' | translate) }}
      </p>
      <p class="message-number">
        {{ 'userabout.createdByOn' | translate:{ name: (groupCreatedBy || ('userabout.defaults.unknown' | translate)) }
        }}
        {{ groupCreatedAt ? (groupCreatedAt | date: 'dd MMMM yyyy, h:mm a') : ('userabout.defaults.unknownDate' |
        translate) }}
      </p>
    </ng-container>
  </div>




  <!-- Media Section (Common) -->
  <!-- <div class="main-media">
    <div class="all-media">
      <p class="docs">{{ 'userabout.media.title' | translate }}</p>
      <div class="media-count">
        <ion-button fill="clear" routerLink="/" class="no-decoration">20</ion-button>
        <ion-icon name="chevron-forward-outline"></ion-icon>
      </div>
    </div>

    <swiper-container [attr.slides-per-view]="4" [attr.space-between]="10" class="slider">
      <swiper-slide *ngFor="let item of [].constructor(15)" class="slider-swip">
        <div class="image-wrapper">
          <img src="assets/images/user.jfif" alt="Rectangle-img" />
        </div>
      </swiper-slide>
    </swiper-container>
  </div> -->

  <!-- Notification Section (Common) -->
  <ion-list lines="none" class="noti-list">
    <!-- <ion-item>
      <ion-icon name="notifications-outline" slot="start" class="all-icon"></ion-icon>
      <ion-label class="Encry">{{ 'userabout.notifications' | translate }}</ion-label>
    </ion-item>
    <ion-item>
      <ion-icon name="image-outline" slot="start" class="all-icon"></ion-icon>
      <ion-label class="Encry">{{ 'userabout.mediaVisibility' | translate }}</ion-label>
    </ion-item> -->
  </ion-list>

  <!-- Encryption and Privacy Settings (Only for Private Chat) -->
  <ion-list lines="none" class="noti-list" *ngIf="chatType === 'private'">
    <ion-item class="jha">
      <ion-icon name="lock-closed-outline" slot="start" class="all-icon"></ion-icon>
      <ion-label>
        <div>
          <div class="Encry">{{ 'userabout.encryption.title' | translate }}</div>
          <div class="encrypted">{{ 'userabout.encryption.subtitle' | translate }}</div>
        </div>
      </ion-label>
    </ion-item>
    <ion-item class="jha">
      <ion-icon name="timer-outline" slot="start" class="all-icon"></ion-icon>
      <ion-label class="Encry">{{ 'userabout.disappearing' | translate }}</ion-label>
    </ion-item>
    <ion-item class="jha">
      <ion-icon name="lock-closed-outline" slot="start" class="all-icon"></ion-icon>
      <ion-label>
        <div>
          <div class="Encry">{{ 'userabout.chatLock.title' | translate }}</div>
          <div class="encrypted">{{ 'userabout.chatLock.subtitle' | translate }}</div>
        </div>
      </ion-label>
      <ion-icon name="toggle-outline" class="all-icon"></ion-icon>
    </ion-item>
    <ion-item class="jha">
      <ion-icon name="shield-half-outline" slot="start" class="all-icon"></ion-icon>
      <ion-label>
        <div>
          <div class="Encry">{{ 'userabout.advancedPrivacy.title' | translate }}</div>
          <div class="encrypted">{{ 'userabout.advancedPrivacy.off' | translate }}</div>
        </div>
      </ion-label>
    </ion-item>
  </ion-list>

  <!-- private Info Section (Only for private Chat) -->
  <ion-list lines="none" class="noti-list" *ngIf="chatType === 'private'">
    <!-- <ion-label class="total-group">2 Groups in Common</ion-label> -->
    <!-- <ion-label class="total-group">
      {{ commonGroups.length }} Group{{ commonGroups.length > 1 ? 's' : '' }} in Common
    </ion-label> -->
    <ion-label class="total-group">
      {{ commonGroups.length }} {{ commonGroups.length > 1 ? ('userabout.groups' | translate) : ('userabout.group' |
      translate) }} {{ 'userabout.inCommon' | translate }}
    </ion-label>

    <ion-item class="jha" (click)="createGroupWithMember()">
      <ion-icon name="person-outline" class="all-icon" slot="start"></ion-icon>
      <ion-label class="Encry">{{ 'userabout.createGroupWith' | translate:{ name: receiver_name } }}</ion-label>
    </ion-item>



    <ion-item *ngFor="let group of commonGroups" class="jha">
      <ion-avatar slot="start">
        <img [src]="'assets/images/user.jfif'" />
      </ion-avatar>
      <ion-label>
        <div class="Encry">{{ group.name || ('userabout.unnamedGroup' | translate) }}</div>
        <div class="encrypted">{{ 'userabout.commonGroupWith' | translate:{ name: receiver_name } }}</div>
      </ion-label>
    </ion-item>
  </ion-list>

  <!-- Group Members Section -->
  <ion-list *ngIf="chatType === 'group'" lines="none" class="noti-list">
    <!-- Group members -->
<ion-item>
  <ion-icon name="people-outline" slot="start" class="all-icon"></ion-icon>
  <ion-label class="Encry">
    {{ 'userabout.groupMembers' | translate }} ({{ groupMembers.length }})
  </ion-label>
</ion-item>
<ion-item>
  <ion-button fill="clear" slot="start" (click)="onAddMember()">
    <ion-icon name="person-add-outline" slot="start" class="all-icon1"></ion-icon>
  </ion-button>
  <ion-label class="Encry" (click)="onAddMember()">
    {{ 'userabout.addMembers' | translate }}
  </ion-label>
</ion-item>

    <ion-item *ngFor="let member of groupMembers" (click)="openActionSheet(member)">
  <ion-avatar slot="start">
    <img [src]="member.avatar || 'assets/images/user.jfif'" />
  </ion-avatar>

  <ion-label>
    <div class="Encry">
      {{ member.username }}
    </div>
    <!-- Optional: Show phone number -->
    <!-- <p style="font-size: 12px; color: gray;">{{ member.phoneNumber }}</p> -->
  </ion-label>

  <ion-badge *ngIf="isAdmin(member.user_id)" class="admin-badge" style="margin-left:6px;font-size:10px;color:red;background-color:#FFD4D4;">
    {{ 'userabout.groupAdmin' | translate }}
  </ion-badge>
</ion-item>


    <ion-item *ngIf="hasPastMembers">
  <ion-icon name="people-outline" slot="start" class="all-icon"></ion-icon>
  <ion-label class="Encry1" (click)="viewPastMembers()">{{ 'userabout.viewPastMembers' | translate }}</ion-label>
</ion-item>


  </ion-list>

  <!-- User Management Options (Common) -->
  <ion-list lines="none" class="noti-list">

<ion-item class="jha">
  <ion-icon name="heart-outline" slot="start" class="all-icon"></ion-icon>
  <ion-label class="Encry">{{ 'userabout.addToFavourites' | translate }}</ion-label>
</ion-item>

    <ion-item class="jha">
  <ion-icon name="person-add-outline" slot="start" class="all-icon"></ion-icon>
  <ion-label class="Encry">{{ 'userabout.addToList' | translate }}</ion-label>
</ion-item>
    
 <ion-item class="jha exit-group-item" *ngIf="chatType === 'group'" (click)="confirmExitGroup()" >
    <ion-icon name="log-out-outline" slot="start" class="all-icon"></ion-icon>
    <!-- <ion-label class="Encry">{{ 'userabout.exitGroup' | translate }}</ion-label> -->
    <ion-label class="Encry">Exit Group</ion-label>
  </ion-item>

    <!-- ✅ Block / Unblock toggle (only private chat) -->
    <!-- <ion-item 
    class="jha" 
    *ngIf="chatType === 'private' && !isBlocked" 
    (click)="blockUser()">
    <ion-icon name="ban-outline" slot="start" class="all-icon"></ion-icon>
    <ion-label class="Encry">Block {{ receiver_name }}</ion-label>
  </ion-item>

  <ion-item 
    class="jha" 
    *ngIf="chatType === 'private' && isBlocked" 
    (click)="unblockUser()">
    <ion-icon name="checkmark-circle-outline" slot="start" class="all-icon"></ion-icon>
    <ion-label class="Encry">Unblock {{ receiver_name }}</ion-label>
  </ion-item> -->

   <!-- Block/Unblock -->
<ion-item class="jha" *ngIf="chatType === 'private' && !iBlocked" (click)="blockUser()">
  <ion-icon name="ban-outline" slot="start" class="all-icon"></ion-icon>
  <ion-label class="Encry">{{ 'userabout.block' | translate:{ name: receiver_name } }}</ion-label>
</ion-item>
<ion-item class="jha" *ngIf="chatType === 'private' && iBlocked" (click)="unblockUser()">
  <ion-icon name="checkmark-circle-outline" slot="start" class="all-icon"></ion-icon>
  <ion-label class="Encry">{{ 'userabout.unblock' | translate:{ name: receiver_name } }}</ion-label>
</ion-item>

    <!-- optional: show info if *they have blocked me* -->
    <!-- <ion-item *ngIf="chatType==='private' && theyBlocked" lines="none">
  <ion-icon name="warning-outline" slot="start"></ion-icon>
  <ion-label>
    This user has blocked you — you cannot send messages to them.
  </ion-label>
</ion-item> -->

    <!-- ✅ Report user/group (always visible) -->
  <!-- Report -->
<ion-item class="jha" (click)="reportUser()">
  <ion-icon name="thumbs-down-outline" slot="start" class="all-icon"></ion-icon>
  <ion-label class="Encry">{{ 'userabout.report' | translate:{ name: (isGroup ? groupName : receiver_name) } }}</ion-label>
</ion-item>

  </ion-list>
</ion-content>