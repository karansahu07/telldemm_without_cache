<ion-header translucent>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/status-screen"></ion-back-button>
    </ion-buttons>

    <!-- Channels → Channels -->
    <ion-title>Channels</ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="openRegionFilter()">
        <ion-icon name="filter-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- show active region filter badge -->
  <div class="active-filter-row" *ngIf="selectedRegionName" style="padding:8px 12px;">
    <ion-chip>
      <ion-label>Region: {{ selectedRegionName }}</ion-label>
      <ion-icon name="close-circle" slot="end" (click)="clearRegionFilter()"></ion-icon>
    </ion-chip>

    <!-- Channels → Channels -->
    <span style="margin-left:8px;color:var(--ion-color-medium);font-size:13px;">
      Showing Channels for selected region
    </span>
  </div>
</ion-header>

<ion-content class="channels-page" fullscreen>
  <ion-refresher slot="fixed" (ionRefresh)="loadChannels($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- category quick filter -->
  <div class="category-bar" *ngIf="categories.length">
    <ion-segment [(ngModel)]="selectedCategoryId" (ionChange)="onCategorySelected($event)" value="all" scrollable>
      <ion-segment-button value="all"><ion-label>All</ion-label></ion-segment-button>
      <ion-segment-button *ngFor="let cat of categories" [value]="cat.id">
        <ion-label>{{ cat.category_name }}</ion-label>
      </ion-segment-button>
    </ion-segment>
  </div>

  <!-- loading skeleton -->
  <ion-list *ngIf="isLoading">
    <ion-item *ngFor="let i of [1,2,3,4]">
      <ion-skeleton-text style="width:44px; height:44px; border-radius:50%"></ion-skeleton-text>
      <ion-label>
        <ion-skeleton-text style="width:50%"></ion-skeleton-text>
        <ion-skeleton-text style="width:30%"></ion-skeleton-text>
      </ion-label>
    </ion-item>
  </ion-list>

  <!-- ========== CATEGORY SECTIONS (compact) ========== -->
  <ng-container *ngIf="!isLoading && !categoryFullViewActive">
    <ng-container *ngFor="let group of pagedGroupedCategories">
      <ng-container *ngIf="selectedCategoryId === 'all' || selectedCategoryId === group.id">
        <ion-item lines="none" class="section-title">
          <ion-label>
            <h2>{{ group.name }}</h2>
          </ion-label>
          <ion-button fill="clear" slot="end" (click)="openCategoryFullView(group.id, group.name)">See all</ion-button>
        </ion-item>

        <ion-list>
          <ion-item class="megatell-item" *ngFor="let ch of group.channels" >
            <ion-avatar slot="start" (click)="openChannelDetail(ch)">
              <img [src]="ch.avatar || placeholderAvatar" alt="megatell" />
            </ion-avatar>

            <ion-label>
              <h3 class="megatell-name">
                {{ ch.name }}
                <ion-icon *ngIf="ch.verified" name="checkmark-circle" color="primary" class="verified-icon"></ion-icon>
              </h3>

              <p class="followers">{{ ch.followers }} followers</p>
            </ion-label>

            <ion-button class="follow-btn" fill="solid" [color]="ch.following ? 'medium' : 'primary'"
              shape="round" size="small" (click)="toggleFollow(ch)" [disabled]="loadingChannelId === ch.id">

              <ion-spinner name="crescent" *ngIf="loadingChannelId === ch.id"></ion-spinner>
              <span *ngIf="loadingChannelId !== ch.id">
                {{ ch.following ? 'Following' : 'Follow' }}
              </span>
            </ion-button>

            <!-- owner badge -->
            <ion-badge *ngIf="isOwner(ch)" color="warning" slot="end" class="owner-badge">Owner</ion-badge>
          </ion-item>
        </ion-list>
      </ng-container>
    </ng-container>

    <!-- infinite scroll -->
    <ion-infinite-scroll threshold="100px" (ionInfinite)="loadMoreCategories($event)" [disabled]="!hasMoreCategories">
      <ion-infinite-scroll-content loadingSpinner="bubbles"
        loadingText="Loading more categories..."></ion-infinite-scroll-content>
    </ion-infinite-scroll>
  </ng-container>

  <!-- ========== CATEGORY FULL VIEW ========== -->
  <ng-container *ngIf="categoryFullViewActive">
    <ion-item lines="none" class="section-title">
      <ion-buttons slot="start">
        <ion-button fill="clear" (click)="closeCategoryFullView()">
          <ion-icon name="arrow-back-outline"></ion-icon>
        </ion-button>
      </ion-buttons>

      <ion-label>
        <h2>{{ activeCategoryName }}</h2>
      </ion-label>

      <ion-button fill="clear" slot="end" (click)="openRegionFilter()">Filter</ion-button>
    </ion-item>

    <ion-list>
      <ion-item *ngFor="let ch of categoryChannels" >
        <ion-avatar slot="start" (click)="openChannelDetail(ch)">
          <img [src]="ch.avatar || placeholderAvatar" alt="megatell" />
        </ion-avatar>

        <ion-label>
          <h3>{{ ch.name }}</h3>
          <p class="followers">{{ ch.followers | number }} followers</p>
        </ion-label>

        <ion-button fill="clear" (click)="toggleFollow(ch)">
          {{ ch.following ? 'Following' : 'Follow' }}
        </ion-button>
      </ion-item>
    </ion-list>

    <!-- infinite scroll -->
    <ion-infinite-scroll threshold="100px" (ionInfinite)="loadMoreCategoryChannels($event)"
      [disabled]="!hasMoreCategoryChannels">
      <ion-infinite-scroll-content loadingSpinner="bubbles"
        loadingText="Loading more Channels..."></ion-infinite-scroll-content>
    </ion-infinite-scroll>
  </ng-container>

  <!-- empty state -->
  <div *ngIf="!isLoading && !categoryFullViewActive && (!pagedGroupedCategories || pagedGroupedCategories.length === 0)"
    class="empty-state">
    <p>No Channels found.</p>
    <ion-button (click)="loadChannels()" fill="outline">Retry</ion-button>
  </div>
</ion-content>
