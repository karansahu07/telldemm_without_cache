<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/"></ion-back-button>
    </ion-buttons>

    <ion-chip slot="end" [color]="isOnline ? 'success' : 'warning'" *ngIf="!isOnline">
      <ion-icon name="cloud-offline-outline"></ion-icon>
      <ion-label>Offline</ion-label>
    </ion-chip>

    <ion-title>
      <div class="header-content">
        <ion-avatar class="header-avatar" (click)="onHeaderClick()">
          <img *ngIf="channel?.channel_dp" [src]="channel!.channel_dp" alt="Channel Avatar" />
          <div *ngIf="!channel?.channel_dp" class="avatar-placeholder">{{ (channel?.channel_name || 'C')[0] }}</div>
        </ion-avatar>

        <div class="header-info">
          <div class="channel-name" (click)="onHeaderClick()">
            {{ channel?.channel_name || 'Loading...' }}
            <span *ngIf="channel?.is_verified" class="verified-badge">‚úì</span>
          </div>
          <div class="channel-followers">{{ channel?.follower_count || 0 }} followers</div>
        </div>
      </div>
    </ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="toggleMute()">
        <ion-icon slot="icon-only" [name]="isMuted ? 'notifications-off-outline' : 'notifications-outline'"></ion-icon>
      </ion-button>
      <ion-button expand="block" color="primary" (click)="dumpDbToConsole()">
        Dump
      </ion-button>
      <!-- <ion-button expand="block" color="primary" (click)="dumpDbToConsole()">
        Dump
      </ion-button>

<ion-button (click)="debugCacheStatus()">Debug Cache</ion-button> -->
      <ion-button>
        <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="channel-content">
  <div class="posts-container">

    <!-- BACKDROP -->
    <div *ngIf="showReactionPopup" class="reaction-backdrop" (click)="closePopup()"></div>

    <!-- CUSTOM REACTION POPUP -->
    <div *ngIf="showReactionPopup" class="reaction-popup" [style.top.px]="popupY" [style.left.px]="popupX">
      <span (click)="react(activePost, 'üëç')">üëç</span>
      <span (click)="react(activePost, '‚ù§Ô∏è')">‚ù§Ô∏è</span>
      <span (click)="react(activePost, 'üòÇ')">üòÇ</span>
      <span (click)="react(activePost, 'üôè')">üôè</span>
      <span class="add-reaction">
        <ion-icon name="add-circle-outline" (click)="openReactionPicker(activePost)"></ion-icon>
      </span>
    </div>

    <!-- POSTS -->
    <!-- <div *ngFor="let p of posts" class="post-bubble" [class.sent]="p.isSent" [class.received]="!p.isSent" -->
    <div *ngFor="let p of posts" class="post-bubble" [class.sent]="p.created_by === currentUserId"
      [class.received]="p.created_by !== currentUserId" (touchstart)="onTouchStart($event, p)"
      (touchmove)="onTouchMove($event)" (touchend)="onTouchEnd(p)">

      <!-- Multi-select checkbox -->
      <div *ngIf="selectionMode" class="checkbox-container">
        <ion-checkbox [checked]="selectedPosts.has(p.id)" (ionChange)="toggleSelect(p)"></ion-checkbox>
      </div>

      <div *ngIf="p.created_by !== currentUserId" class="author-info">
        <ion-avatar class="author-avatar">
          <div class="avatar-placeholder">
            {{ getUserInitial(p.created_by) }}
          </div>
        </ion-avatar>
        <div class="author-details">
          <span class="author-name">{{ getUserName(p.created_by) }}</span>
        </div>
      </div>

      <div class="message-wrapper">
        <img *ngIf="p.image" [src]="p.image" class="post-image" />

        <div class="bubble-content">
          <p class="post-text">{{ p.body }}</p>

          <div class="message-footer">
            <span class="timestamp">
              {{ p.timestamp | date:'shortTime' }}
            </span>
            <!-- <span *ngIf="p.isSent" class="read-status">‚úì‚úì</span> -->
            <span *ngIf="p.created_by === currentUserId" class="read-status">‚úì‚úì</span>
          </div>
        </div>
      </div>

      <!-- REACTIONS BAR WITH FORWARD (ALWAYS VISIBLE) -->
      <!-- REACTIONS BAR WITH FORWARD (SHOW OFFLINE STATE) -->
      <div class="reactions-bar">
        <!-- Show reactions if any exist -->
        <div class="reactions-wrapper">
          <div class="reactions-list" *ngIf="getAggregatedReactions(p) | keyvalue as reactions">
            <div class="reaction-item" *ngFor="let r of reactions"
              (click)="isOnline ? showReactionActionSheet(p, r.key) : showOfflineToast('Reactions unavailable offline')"
              [class.disabled]="!isOnline">
              <span class="emoji">{{ r.key }}</span>
              <span class="count">{{ r.value }}</span>
            </div>
          </div>
        </div>

        <!-- Forward button (ALWAYS VISIBLE) -->
        <ion-button fill="clear" class="forward-btn" size="small" (click)="forwardPost(p)">
          <ion-icon slot="icon-only" name="arrow-redo-outline"></ion-icon>
        </ion-button>
      </div>

    </div>

  </div>

  <!-- Update the read-only banner to mention reactions are disabled -->
  <div *ngIf="!canCreatePost || !isOnline" class="read-only-banner">
    <ion-icon [name]="!isOnline ? 'cloud-offline-outline' : 'eye-outline'"></ion-icon>
    <span *ngIf="!isOnline">Offline - View only</span>
    <span *ngIf="canCreatePost && isOnline">View only - You can react to posts</span>
  </div>
</ion-content>

<!-- INPUT BAR -->
<ion-footer class="chat-footer" *ngIf="canCreatePost">
  <div class="input-row">
    <ion-button fill="clear" class="attach-btn" (click)="selectMedia()">
      <ion-icon name="attach-outline"></ion-icon>
    </ion-button>

    <!-- Combined Preview + Input -->
    <div *ngIf="selectedFile" class="combined-preview">
      <div class="media-container">
        <img *ngIf="isImage(selectedFile)" [src]="selectedImage" class="preview-image" alt="Media Preview" />
        <video *ngIf="!isImage(selectedFile)" [src]="selectedImage" class="preview-video" controls></video>
        <ion-button fill="clear" size="small" (click)="clearMedia()" class="remove-preview">
          <ion-icon name="close-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </div>

      <div class="caption-input-wrapper">
        <ion-input class="caption-input" [(ngModel)]="newMessage" placeholder="Add a caption..."
          [disabled]="isUploading"></ion-input>
      </div>
    </div>

    <!-- Fallback: Plain Input -->
    <ion-input *ngIf="!selectedFile" class="chat-input" [(ngModel)]="newMessage"
      placeholder="Type a message"></ion-input>

    <ion-button fill="clear" class="send-btn" (click)="sendPost()"
      [disabled]="isUploading || (!newMessage && !selectedFile)">
      <ion-icon name="send"></ion-icon>
    </ion-button>
  </div>

  <!-- Upload Progress Bar -->
  <ion-progress-bar *ngIf="isUploading" [value]="uploadProgress / 100" color="primary"
    class="upload-progress"></ion-progress-bar>
</ion-footer>