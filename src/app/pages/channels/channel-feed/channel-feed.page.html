<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/"></ion-back-button>
    </ion-buttons>

    <ion-title>
      <div class="header-content">
        <ion-avatar class="header-avatar">
          <div class="avatar-placeholder">V</div>
        </ion-avatar>

        <div class="header-info">
          <div class="channel-name">Volunteer Events</div>
          <div class="channel-followers">56 followers</div>
        </div>
      </div>
    </ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="testAddPost()">
        <ion-icon slot="icon-only" name="link-outline"></ion-icon>
      </ion-button>

      <ion-button>
        <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="channel-content">
  <div class="posts-container">

    <!-- BACKDROP -->
    <div
      *ngIf="showReactionPopup"
      class="reaction-backdrop"
      (click)="closePopup()"
    ></div>

    <!-- CUSTOM REACTION POPUP -->
    <div
      *ngIf="showReactionPopup"
      class="reaction-popup"
      [style.top.px]="popupY"
      [style.left.px]="popupX"
    >
      <span (click)="react(activePost, 'üëç')">üëç</span>
      <span (click)="react(activePost, '‚ù§Ô∏è')">‚ù§Ô∏è</span>
      <span (click)="react(activePost, 'üòÇ')">üòÇ</span>
      <span (click)="react(activePost, 'üôè')">üôè</span>
      <span (click)="react(activePost, 'üî•')">üî•</span>
    </div>

    <!-- POSTS -->
    <div
      *ngFor="let p of posts"
      class="post-bubble"
      [class.sent]="p.isSent"
      [class.received]="!p.isSent"
      (touchstart)="onTouchStart($event, p)"
      (touchmove)="onTouchMove($event)"
      (touchend)="onTouchEnd(p)"
    >

      <!-- Multi-select checkbox -->
      <div *ngIf="selectionMode" class="checkbox-container">
        <ion-checkbox
          [checked]="selectedPosts.has(p.id)"
          (ionChange)="toggleSelect(p)"
        ></ion-checkbox>
      </div>

      <!-- Author info for received messages -->
      <div *ngIf="!p.isSent" class="author-info">
        <ion-avatar class="author-avatar">
          <div class="avatar-placeholder">
            {{ (p.author || 'U')[0] }}
          </div>
        </ion-avatar>
        <div class="author-details">
          <span class="author-name">{{ p.author || 'Unknown' }}</span>
          <span *ngIf="p.verified" class="verified-badge">‚úì</span>
        </div>
      </div>

      <div class="message-wrapper">
        <img *ngIf="p.image" [src]="p.image" class="post-image" />

        <div class="bubble-content">
          <p class="post-text">{{ p.body }}</p>

          <div class="message-footer">
            <span class="timestamp">
              {{ p.timestamp | date:'shortTime' }}
            </span>
            <span *ngIf="p.isSent" class="read-status">‚úì‚úì</span>
          </div>
        </div>
      </div>

      <div class="reactions-bar" *ngIf="p.reactions && (p.reactions | keyvalue).length > 0">
        <div class="reaction-item" *ngFor="let r of p.reactions | keyvalue">
          <span class="emoji">{{ r.key }}</span>
          <span class="count">{{ r.value }}</span>
        </div>
        <ion-button fill="clear" class="forward-btn" size="small">
          <ion-icon name="arrow-redo-outline"></ion-icon>
        </ion-button>
      </div>

    </div>

  </div>
</ion-content>

<!-- INPUT BAR -->
<ion-footer class="chat-footer">
  <div class="input-row">
    <ion-button fill="clear" class="attach-btn" (click)="selectMedia()">
      <ion-icon name="attach-outline"></ion-icon>
    </ion-button>

    <ion-input
      class="chat-input"
      [(ngModel)]="newMessage"
      placeholder="Type a message"
    ></ion-input>

    <!-- Media Preview -->
    <div *ngIf="selectedImage" class="media-preview">
      <img [src]="selectedImage" alt="Preview" class="preview-image" />
      <ion-button fill="clear" size="small" (click)="clearMedia()" class="remove-preview">
        <ion-icon name="close-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </div>

    <ion-button fill="clear" class="send-btn" (click)="sendPost()" [disabled]="isUploading">
      <ion-icon name="send"></ion-icon>
    </ion-button>
  </div>

  <!-- Upload Progress Bar -->
  <ion-progress-bar
    *ngIf="isUploading"
    [value]="uploadProgress / 100"
    color="primary"
    class="upload-progress"
  ></ion-progress-bar>
</ion-footer>