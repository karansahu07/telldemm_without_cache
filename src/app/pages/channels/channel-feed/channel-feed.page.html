<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/"></ion-back-button>
    </ion-buttons>

    <ion-chip slot="end" [color]="isOnline ? 'success' : 'warning'" *ngIf="!isOnline">
      <ion-icon name="cloud-offline-outline"></ion-icon>
      <ion-label>Offline</ion-label>
    </ion-chip>

    <ion-title>
      <div class="header-content">
        <ion-avatar class="header-avatar" (click)="onHeaderClick()">
          <img *ngIf="channel?.channel_dp" [src]="channel!.channel_dp" />
          <div *ngIf="!channel?.channel_dp" class="avatar-placeholder">
            {{ (channel?.channel_name || 'C')[0] }}
          </div>
        </ion-avatar>

        <div class="header-info">
          <div class="channel-name" (click)="onHeaderClick()">
            {{ channel?.channel_name || 'Loading...' }}
            <span *ngIf="channel?.is_verified" class="verified-badge">‚úì</span>
          </div>
          <div class="channel-followers">
            {{ channel?.follower_count || 0 }} followers
          </div>
        </div>
      </div>
    </ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="toggleMute()">
        <ion-icon
          slot="icon-only"
          [name]="isMuted ? 'notifications-off-outline' : 'notifications-outline'">
        </ion-icon>
      </ion-button>

      <ion-button expand="block" color="primary" (click)="dumpDbToConsole()">
        Dump
      </ion-button>

      <ion-button>
        <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<!-- ================= CONTENT ================= -->
<ion-content class="channel-content">
  <div class="posts-container">

    <!-- BACKDROP -->
    <div *ngIf="showReactionPopup" class="reaction-backdrop" (click)="closePopup()"></div>

    <!-- REACTION POPUP -->
    <div
      *ngIf="showReactionPopup"
      class="reaction-popup"
      [style.top.px]="popupY"
      [style.left.px]="popupX">
      <span (click)="react(activePost, 'üëç')">üëç</span>
      <span (click)="react(activePost, '‚ù§Ô∏è')">‚ù§Ô∏è</span>
      <span (click)="react(activePost, 'üòÇ')">üòÇ</span>
      <span (click)="react(activePost, 'üôè')">üôè</span>
      <span class="add-reaction">
        <ion-icon
          name="add-circle-outline"
          (click)="openReactionPicker(activePost)">
        </ion-icon>
      </span>
    </div>

    <!-- POSTS -->
    <div
      *ngFor="let p of posts"
      class="post-bubble"
      [class.sent]="p.created_by === currentUserId"
      [class.received]="p.created_by !== currentUserId"
      (touchstart)="onTouchStart($event, p)"
      (touchmove)="onTouchMove($event)"
      (touchend)="onTouchEnd(p)">

      <!-- MULTI SELECT -->
      <div *ngIf="selectionMode" class="checkbox-container">
        <ion-checkbox
          [checked]="selectedPosts.has(p.id)"
          (ionChange)="toggleSelect(p)">
        </ion-checkbox>
      </div>

      <!-- AUTHOR -->
      <div *ngIf="p.created_by !== currentUserId" class="author-info">
        <ion-avatar class="author-avatar">
          <div class="avatar-placeholder">
            {{ getUserInitial(p.created_by) }}
          </div>
        </ion-avatar>
        <div class="author-details">
          <span class="author-name">{{ getUserName(p.created_by) }}</span>
        </div>
      </div>

      <!-- MESSAGE -->
      <div class="message-wrapper">
        <img *ngIf="p.image" [src]="p.image" class="post-image" />

        <div class="bubble-content">
          <p class="post-text">{{ p.body }}</p>

          <div class="message-footer">
            <span class="timestamp">
              {{ p.timestamp | date:'shortTime' }}
            </span>
            <span *ngIf="p.created_by === currentUserId" class="read-status">‚úì‚úì</span>
          </div>
        </div>
      </div>

      <!-- REACTIONS -->
      <div class="reactions-bar">
        <div class="reactions-wrapper">
          <div class="reactions-list"
               *ngIf="getAggregatedReactions(p) | keyvalue as reactions">
            <div
              class="reaction-item"
              *ngFor="let r of reactions"
              (click)="isOnline ? showReactionActionSheet(p, r.key) : showOfflineToast('Reactions unavailable offline')"
              [class.disabled]="!isOnline">
              <span class="emoji">{{ r.key }}</span>
              <span class="count">{{ r.value }}</span>
            </div>
          </div>
        </div>

        <ion-button
          fill="clear"
          class="forward-btn"
          size="small"
          (click)="forwardPost(p)">
          <ion-icon slot="icon-only" name="arrow-redo-outline"></ion-icon>
        </ion-button>
      </div>

    </div>
  </div>

  <!-- READ ONLY -->
  <div *ngIf="!canCreatePost || !isOnline" class="read-only-banner">
    <ion-icon [name]="!isOnline ? 'cloud-offline-outline' : 'eye-outline'"></ion-icon>
    <span *ngIf="!isOnline">Offline - View only</span>
    <span *ngIf="canCreatePost && isOnline">View only - You can react</span>
  </div>
</ion-content>

<!-- ================= PREVIEW MODAL (SAME AS CHAT) ================= -->
<ion-modal
  [isOpen]="showPreviewModal"
  (didDismiss)="cancelPreview()">

  <ng-template>
    <ion-header [translucent]="true" class="model-header">
      <ion-toolbar class="model-toll">

        <!-- ‚ùå CLOSE -->
        <ion-buttons slot="start">
          <ion-icon
            name="close"
            style="font-size: 26px"
            (click)="cancelPreview()">
          </ion-icon>
        </ion-buttons>

        <!-- ‚úÇÔ∏è CROP (IMAGE ONLY) -->
        <ion-buttons slot="end">
          <img
            *ngIf="selectedAttachment?.type === 'image'"
            src="assets/images/crop-simple-solid-full.svg"
            style="width: 22px; height: 22px"
            (click)="openCropperModal()" />
        </ion-buttons>

      </ion-toolbar>
    </ion-header>

    <ion-content>
      <div class="pre-model">

        <div class="mine2">
          <!-- IMAGE -->
          <img
            *ngIf="selectedAttachment?.type === 'image'"
            [src]="selectedAttachment?.previewUrl"
            class="preview-image" />

          <!-- VIDEO -->
          <video
            *ngIf="selectedAttachment?.type === 'video'"
            [src]="selectedAttachment?.previewUrl"
            controls
            class="preview-video">
          </video>

          <!-- FILE -->
          <div *ngIf="selectedAttachment?.type === 'file'" class="preview-file">
            <ion-icon name="document-attach-outline"></ion-icon>
            <p>{{ selectedAttachment?.fileName }}</p>
          </div>
        </div>

        <!-- CAPTION + SEND -->
        <div class="mine ion-padding">
          <ion-textarea
            [(ngModel)]="messageText"
            placeholder="Type your message here..."
            class="pre-message">
          </ion-textarea>

          <div class="sendbtn">
            <ion-icon
              name="send-outline"
              class="mediasend"
              (click)="sendFromPreview()">
            </ion-icon>
          </div>
        </div>

      </div>
    </ion-content>
  </ng-template>
</ion-modal>


<!-- ================= FOOTER ================= -->
<ion-footer class="chat-footer" *ngIf="canCreatePost">
  <div class="input-row">

    <ion-button fill="clear" class="attach-btn" (click)="selectMedia()">
      <ion-icon name="attach-outline"></ion-icon>
    </ion-button>


    <!-- NORMAL INPUT -->
    <ion-input
      *ngIf="!selectedAttachment"
      class="chat-input"
      [(ngModel)]="newMessage"
      placeholder="Type a message">
    </ion-input>

    <ion-button
      fill="clear"
      class="send-btn"
      (click)="sendPost()"
      [disabled]="isUploading || (!newMessage && !selectedAttachment)">
      <ion-icon name="send"></ion-icon>
    </ion-button>
  </div>

  <ion-progress-bar
    *ngIf="isUploading"
    [value]="uploadProgress / 100"
    color="primary"
    class="upload-progress">
  </ion-progress-bar>
</ion-footer>
